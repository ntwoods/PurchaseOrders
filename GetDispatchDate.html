<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>üì¶ Purchase Order Management</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(135deg,#f8fbff,#e3f2fd);
      color:#1a237e;
      padding:20px;
      min-height:100vh;
    }

    .container { max-width:1200px; margin:0 auto; }

    .header { text-align:center; margin-bottom:30px; }
    .header h1 {
      font-size:2.4rem; font-weight:700; color:#0d47a1;
      margin-bottom:8px; letter-spacing:-0.5px;
    }
    .header p { font-size:1.05rem; color:#455a64; }

    .status-bar {
      background:#fff; border:1px solid #bbdefb;
      border-radius:16px; padding:15px 20px;
      display:flex; justify-content:space-between; align-items:center;
      box-shadow:0 4px 12px rgba(0,0,0,0.05); margin-bottom:25px;
    }
    .status-item { display:flex; align-items:center; gap:8px; color:#1e3d7a; }
    .status-indicator {
      width:10px; height:10px; border-radius:50%; background:#1976d2;
      animation:pulse 2s infinite;
    }
    @keyframes pulse { 0%{opacity:1;} 50%{opacity:.5;} 100%{opacity:1;} }

    .orders-grid {
      display:grid; grid-template-columns:repeat(auto-fill,minmax(380px,1fr));
      gap:24px;
    }

    .order-card {
      background:#fff; border-radius:20px; padding:22px;
      box-shadow:0 6px 18px rgba(0,0,0,0.08);
      border:1px solid #e3f2fd; position:relative; overflow:hidden;
      transition:transform .2s;
    }
    .order-card:hover { transform:translateY(-4px); }
    .order-card::before {
      content:''; position:absolute; top:0; left:0; right:0; height:4px;
      background:linear-gradient(90deg,#2196f3,#0d47a1);
    }

    .po-number {
      position:absolute; top:16px; right:20px;
      background:#e3f2fd; color:#0d47a1;
      font-weight:600; padding:5px 10px; border-radius:8px;
      font-size:.9rem;
    }

    .requester-name { font-size:1.3rem; font-weight:600; color:#0d47a1; margin-bottom:8px; }
    .timestamp { font-size:.9rem; color:#455a64; line-height:1.4; }

    .order-actions { margin:16px 0; }
    .view-po-btn {
      width:100%; padding:11px 18px; font-size:.95rem; font-weight:600;
      background:linear-gradient(45deg,#42a5f5,#1e88e5); color:white;
      border:none; border-radius:10px; cursor:pointer;
      transition:all .25s; display:flex; justify-content:center; align-items:center; gap:6px;
    }
    .view-po-btn:hover { box-shadow:0 4px 12px rgba(33,150,243,0.3); transform:translateY(-2px); }

    .dispatch-section { border-top:1px solid #e0e0e0; padding-top:18px; }
    .dispatch-label { font-weight:600; margin-bottom:8px; color:#1a237e; display:block; }

    .dispatch-input {
      width:100%; padding:10px; border:2px solid #e0e0e0;
      border-radius:8px; font-size:.95rem; margin-bottom:14px;
    }
    .dispatch-input:focus { outline:none; border-color:#2196f3; }

    .button-group { display:flex; gap:10px; margin-top:10px; }
    .submit-btn, .hold-btn {
      flex:1; padding:11px; font-size:.95rem; font-weight:600;
      border:none; border-radius:10px; cursor:pointer; transition:.25s;
    }
    .submit-btn { background:linear-gradient(45deg,#1976d2,#0d47a1); color:#fff; }
    .submit-btn:hover { box-shadow:0 4px 12px rgba(25,118,210,0.3); }
    .hold-btn { background:linear-gradient(45deg,#ffb300,#fb8c00); color:white; }
    .hold-btn:hover { box-shadow:0 4px 12px rgba(255,152,0,0.3); }

    .mark-hold-btn {
      margin-top:10px; width:100%; padding:11px;
      background:linear-gradient(45deg,#29b6f6,#0288d1); color:white;
      border:none; border-radius:10px; font-weight:600; cursor:pointer;
    }
    .mark-hold-btn:hover { box-shadow:0 4px 12px rgba(2,136,209,0.3); }

    .countdown-timer { font-size:.95rem; font-weight:500; color:#e65100; margin-top:6px; }

    .hold-fields {
      margin-top:12px; padding:12px; border-radius:10px;
      border:1px solid #ffe082; background:#fff8e1;
      display:none; transition:.3s;
    }
    .hold-fields.show { display:block; }

    .error, .success {
      margin:15px 0; padding:12px; border-radius:8px; text-align:center; font-weight:500;
    }
    .error { background:#ffebee; border:1px solid #ef9a9a; color:#c62828; }
    .success { background:#e8f5e9; border:1px solid #81c784; color:#2e7d32; }

    .notification-prompt {
      background:#e3f2fd; border:1px solid #2196f3; padding:12px;
      border-radius:8px; text-align:center; margin-bottom:15px; cursor:pointer;
      color:#1565c0; font-weight:500;
    }
    .notification-prompt:hover { background:#bbdefb; }

    .order-card.overdue {
      border: 2px solid #ef5350;
      background: #ffebee; /* light red highlight */
    }
    .countdown-timer {
      font-size: .95rem;
      font-weight: 600;
      color: #d32f2f; /* red text */
    }
    
  </style>
</head>
<body>
<div class="container">
  <div class="header">
    <h1>üì¶ Purchase Order Management</h1>
    <p>Call Supplier & Get the tentative dispatch date for each Order</p>
  </div>

  <div class="status-bar">
    <div class="status-item"><div class="status-indicator"></div> Auto-refresh: <span id="refresh-status">Active</span></div>
    <div class="status-item">Total Orders: <span id="order-count">0</span></div>
    <div class="status-item">Last Updated: <span id="last-updated">--</span></div>
  </div>

  <div id="notification-prompt" class="notification-prompt" style="display:none;">
    üîî Click here to enable sound notifications
  </div>

  <div id="loading" class="loading"><span class="material-icons spin">autorenew</span> Loading orders...</div>
  <div id="error-message" class="error" style="display:none;"></div>
  <div id="success-message" class="success" style="display:none;"></div>

  <div id="orders-container" class="orders-grid"></div>
</div>

<script>
  let orders = [];
  let previousOrderCount = 0;
  let refreshInterval;
  const apiUrl = 'https://script.google.com/macros/s/AKfycbwyskduPHfiIO3d8tuLY4dA0pbRKQeK1ZUvkUXPJFYs5NEPo8eJBCt_dT2UzuJaBub1/exec';
  const postUrl = 'https://script.google.com/macros/s/AKfycbwyskduPHfiIO3d8tuLY4dA0pbRKQeK1ZUvkUXPJFYs5NEPo8eJBCt_dT2UzuJaBub1/exec';
  const DEADLINE_LOG_URL = 'https://script.google.com/macros/s/AKfycbz55kgQ4Xn3Pxp8PCtIaH_d9cvFIPJfAhLh0h4brlT4fZNukDGo3hMYyhTvtI0OyYOyMw/exec';

  function sendDeadlineLog(poNumber, deadline, action){
    if(!DEADLINE_LOG_URL) return;
    fetch(DEADLINE_LOG_URL,{
      method:'POST',mode:'no-cors',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({poNumber,deadline,action})
    }).catch(err=>console.error('Error sending deadline log:',err));
  }

  async function loadOrders(){
    try{
      document.getElementById('loading').style.display='block';
      const res=await fetch(apiUrl); const result=await res.json();
      if(result.success){
        orders=result.data;
        renderOrders();
        updateStatus();
        document.getElementById('loading').style.display='none';
      }
    }catch(err){
      showMessage("Error loading orders: "+err.message,"error");
    }
  }

function calculateDeadline(sentTs){
  const d = new Date(sentTs);
  d.setHours(20,0,0,0); // 8:00 PM same day
  return d;
}

function formatDateTime(d){
  return d.toLocaleString("en-GB",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit"});
}

        
      function renderOrders(){
        const c=document.getElementById('orders-container');
        if(!orders.length){ c.innerHTML="<p style='grid-column:1/-1;text-align:center;'>üì≠ No pending orders</p>"; return;}
        c.innerHTML=orders.map((o,i)=>{
          const deadline = calculateDeadline(o.timestamp);
          return `
            <div class="order-card" id="order-${i}">
              <div class="requester-name">üë§ ${o.supplierName}</div>
              <div class="timestamp">üïí Sent: ${new Date(o.timestamp).toLocaleString()}</div>
              <div class="timestamp">üìå Deadline: ${formatDateTime(deadline)}</div>
              <div class="countdown-timer" id="countdown-${i}"></div>
        <div class="editable">
        <div class="order-actions">
          ${o.googleSheetURL?`<button class="view-po-btn" onclick="window.open('${o.googleSheetURL}')"><span class="material-icons">description</span> View PO</button>`:""}
        </div>
        <div class="dispatch-section">
          <label class="dispatch-label">üìÖ Dispatch Date *</label>
          <input type="date" id="dispatch-${i}" class="dispatch-input"/>
          <div class="button-group">
            <button class="submit-btn" onclick="submitDispatch(${i})">üöÄ Submit</button>
            <button class="hold-btn" onclick="toggleHold(${i})">‚è∏Ô∏è Hold</button>
          </div>
          <div class="hold-fields" id="hold-${i}">
            <label>‚è∞ Hold Until *</label><input type="date" id="hold-until-${i}">
            <label>üìù Remark *</label><input type="text" id="hold-remark-${i}">
            <button class="mark-hold-btn" onclick="markHold(${i})">‚úÖ Mark Hold</button>
          </div>
          </div>
        </div>
        </div>`;
    }).join('');
    startCountdowns();
  }

function startCountdowns(){
  setInterval(()=>{
    orders.forEach((o,i)=>{
      const deadline=calculateDeadline(o.timestamp);
      const now=new Date();
      const el=document.getElementById(`countdown-${i}`);
      const card=document.getElementById(`order-${i}`);
      if(!el||!card) return;
      const diff=deadline-now;
      if(diff<=0){
        el.textContent="Overdue!";
        card.classList.add("overdue");
      }else{
        const h=Math.floor(diff/(1000*60*60));
        const m=Math.floor((diff%(1000*60*60))/(1000*60));
        const s=Math.floor((diff%(1000*60))/1000);
        el.textContent=`‚è≥ ${h}h ${m}m ${s}s left`;
      }
    });
  },1000);
}

  
  async function submitDispatch(i){
    const o=orders[i]; const d=document.getElementById(`dispatch-${i}`).value;
    if(!d){showMessage("Select a dispatch date","error");return;}
    await fetch(postUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'dispatch',timestamp:o.timestamp,dispatchDate:d})});
    sendDeadlineLog(o.purchaseOrderNumber,d,"follow4");
    showMessage("Dispatch submitted successfully!","success");
    orders.splice(i,1); renderOrders(); updateStatus();
  }

  function toggleHold(i){
    document.getElementById(`hold-${i}`).classList.toggle("show");
  }

  async function markHold(i){
    const o=orders[i];
    const u=document.getElementById(`hold-until-${i}`).value;
    const r=document.getElementById(`hold-remark-${i}`).value;
    if(!u||!r){showMessage("Fill hold details","error");return;}
    await fetch(postUrl,{method:'POST',mode:'no-cors',headers:{'Content-Type':'application/json'},body:JSON.stringify({type:'hold',timestamp:o.timestamp,holdUntil:u,holdRemark:r})});
    showMessage("Order placed on hold!","success");
    orders.splice(i,1); renderOrders(); updateStatus();
  }

  function updateStatus(){
    document.getElementById("order-count").textContent=orders.length;
    document.getElementById("last-updated").textContent=new Date().toLocaleTimeString();
  }

  function showMessage(msg,type){
    const e=document.getElementById("error-message"), s=document.getElementById("success-message");
    e.style.display="none"; s.style.display="none";
    if(type==="error"){ e.textContent=msg; e.style.display="block"; }
    else { s.textContent=msg; s.style.display="block"; }
    setTimeout(()=>{e.style.display="none"; s.style.display="none";},4000);
  }

  document.addEventListener("DOMContentLoaded",()=>{
    loadOrders(); refreshInterval=setInterval(loadOrders,120000);
  });
</script>
<script src="https://ntwoods.github.io/ordertodispatch/js/viewOnly.js></script>
</body>
</html>
