<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>CRM Requests Dashboard â€” With Deadline & Countdown</title>
    <style>
        /* (kept your CSS unchanged except kept here for completeness) */
        :root {
            --color-primary: #1976d2;
            --color-secondary: #42a5f5;
            --color-accent: #e3f2fd;
            --color-text-dark: #333;
            --color-text-medium: #555;
            --color-text-light: #666;
            --color-white: #ffffff;
            --color-gray-light: #f5f5f5;
            --color-gray-medium: #e0e0e0;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.08);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.1);
            --shadow-hover: 0 8px 30px rgba(0, 0, 0, 0.15);
            --border-radius-small: 8px;
            --border-radius-medium: 12px;
            --border-radius-large: 16px;
        }
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-white) 100%);
            min-height:100vh; color:var(--color-text-dark); line-height:1.6;
        }
        .header { background:var(--color-white); box-shadow:var(--shadow-light); border-bottom:3px solid var(--color-accent); padding:1.5rem 0; margin-bottom:1.5rem; }
        .header-content { max-width:1200px; margin:0 auto; padding:0 1rem; }
        .header h1 { color:var(--color-primary); font-size:2rem; font-weight:700; margin-bottom:0.25rem; }
        .header p { color:var(--color-secondary); font-size:0.95rem; }
        .container { max-width:1200px; margin:0 auto; padding:0 1rem; }
        .loading { text-align:center; padding:3rem 0; }
        .loading-spinner { width:40px; height:40px; border:3px solid var(--color-accent); border-top:3px solid var(--color-primary); border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 0.75rem; }
        @keyframes spin { 0% { transform: rotate(0deg) } 100% { transform: rotate(360deg) } }
        .requests-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap:1rem; margin-bottom:1.5rem; }
        .request-card { background:var(--color-white); border-radius:var(--border-radius-medium); box-shadow:var(--shadow-medium); border:1px solid var(--color-accent); padding:1.25rem; transition:transform 0.2s ease, box-shadow 0.2s ease; position:relative; overflow:hidden; display:flex; flex-direction:column; justify-content:space-between; height:100%; }
        .request-card.highlighted { background-color:#b5f5d2; border-color:#14914d; }
        .request-card.overdue-card-highlight { background-color:#ffebee; border-color:#ef5350; box-shadow: 0 4px 15px rgba(239,83,80,0.2); }
        .request-card:hover { transform: translateY(-3px); box-shadow:var(--shadow-hover); }
        .watermark { position:absolute; top:50%; left:50%; transform: translate(-50%,-50%) rotate(-45deg); font-size:3em; color:rgba(255,0,0,0.2); pointer-events:none; z-index:1; white-space:nowrap; font-weight:bold; text-transform:uppercase; }
        .field-group { margin-bottom:0.6rem; display:flex; align-items:baseline; }
        .field-label { font-weight:600; color:var(--color-primary); font-size:0.85rem; margin-right:0.5rem; flex-shrink:0; }
        .field-value { color:var(--color-text-medium); font-size:0.9rem; line-height:1.3; word-break:break-word; }
        .action-button { width:100%; background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color:var(--color-white); border:none; padding:0.6rem 1.25rem; border-radius:var(--border-radius-small); font-size:0.95rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; margin-top:1rem; flex-shrink:0; }
        .cancel-button { width:100%; background:#e53935; color:var(--color-white); border:none; padding:0.6rem 1.25rem; border-radius:var(--border-radius-small); font-size:0.95rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; margin-top:0.5rem; flex-shrink:0; }
        .received-button { width:100%; background:#4caf50; color:var(--color-white); border:none; padding:0.6rem 1.25rem; border-radius:var(--border-radius-small); font-size:0.95rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; margin-top:0.5rem; flex-shrink:0; }
        .view-file-button { display:block; width:fit-content; background:var(--color-secondary); color:var(--color-white); border:none; padding:0.4rem 0.8rem; border-radius:var(--border-radius-small); font-size:0.85rem; font-weight:600; cursor:pointer; transition:all 0.2s ease; text-decoration:none; text-align:center; margin-top:0.5rem; }
        .modal-overlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.4); z-index:1000; backdrop-filter: blur(3px); overflow-y:auto; padding:1rem; }
        .modal { background:var(--color-white); border-radius:var(--border-radius-large); box-shadow:0 15px 40px rgba(0,0,0,0.25); width:95%; max-width:450px; padding:1.75rem; position:relative; margin:50px auto; }
        .modal-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:1.25rem; padding-bottom:0.75rem; border-bottom:1px solid var(--color-accent); }
        .modal-title { color:var(--color-primary); font-size:1.35rem; font-weight:700; }
        .close-button { background:none; border:none; font-size:1.35rem; cursor:pointer; color:var(--color-text-light); padding:0.2rem; border-radius:4px; transition:background 0.2s ease; }
        .close-button:hover { background:var(--color-gray-light); color:var(--color-text-dark); }
        .form-group { margin-bottom:1.25rem; }
        .form-label { display:block; margin-bottom:0.4rem; font-weight:600; color:var(--color-primary); font-size:0.9rem; }
        .form-input, .form-select, .form-textarea, .searchable-dropdown-input { width:100%; padding:0.65rem; border:1px solid var(--color-accent); border-radius:var(--border-radius-small); font-size:0.95rem; transition: border-color 0.2s ease, box-shadow 0.2s ease; }
        .form-textarea { resize:vertical; min-height:70px; }
        .searchable-dropdown-container { position:relative; width:100%; }
        .searchable-dropdown-results { position:absolute; width:100%; max-height:180px; overflow-y:auto; background:var(--color-white); border:1px solid var(--color-accent); border-radius:var(--border-radius-small); box-shadow:var(--shadow-light); z-index:1002; margin-top:4px; list-style:none; padding:0.25rem 0; }
        .searchable-dropdown-results div { padding:0.6rem 0.8rem; cursor:pointer; font-size:0.95rem; color:var(--color-text-dark); }
        .searchable-dropdown-results div:hover { background-color:var(--color-accent); color:var(--color-primary); }
        .searchable-dropdown-results div.selected { background-color:var(--color-secondary); color:var(--color-white); }
        .search-clear-button { position:absolute; right:0.75rem; top:50%; transform:translateY(-50%); background:none; border:none; color:var(--color-text-light); font-size:1.1rem; cursor:pointer; padding:0.2rem; line-height:1; display:none; }
        .searchable-dropdown-input:not(:placeholder-shown) + .search-clear-button { display:block; }
        .modal-actions { display:flex; gap:0.75rem; justify-content:flex-end; margin-top:1.5rem; padding-top:0.75rem; border-top:1px solid var(--color-accent); }
        .btn-cancel { background:var(--color-gray-light); color:var(--color-text-light); border:1px solid var(--color-gray-medium); padding:0.65rem 1.25rem; border-radius:var(--border-radius-small); cursor:pointer; font-size:0.95rem; }
        .btn-submit { background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-secondary) 100%); color:var(--color-white); border:none; padding:0.65rem 1.25rem; border-radius:var(--border-radius-small); font-size:0.95rem; font-weight:600; cursor:pointer; }
        .empty-state { text-align:center; padding:3rem 1rem; color:var(--color-text-light); }
        .toast { background-color:rgba(25,118,210,0.9); color:var(--color-white); padding:12px 20px; border-radius:var(--border-radius-small); box-shadow:0 4px 12px rgba(0,0,0,0.2); opacity:0; transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; transform: translateY(-20px); min-width:250px; max-width:350px; }
        .toast.show { opacity:1; transform: translateY(0); }
        .toast.error { background-color: rgba(229,57,53,0.9); }
        .overdue-text { color:#e53935; font-weight:600; }
        .countdown-red { color:#ef5350; font-weight:600; }
        .countdown-yellow { color:#ffb300; font-weight:600; } /* changed from yellow hex to more visible */
        .countdown-green { color:#66bb6a; font-weight:600; }
        @media (max-width:768px) {
            .header h1 { font-size:1.75rem; }
            .requests-grid { grid-template-columns:1fr; }
            .modal { width:98%; padding:1.25rem; }
            .modal-actions { flex-direction:column; }
            .btn-cancel, .btn-submit { width:100%; }
            #toast-container { right:10px; left:10px; top:10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>CRM Requests Dashboard</h1>
            <p>Manage the CRM's requests here and mark the details such as when and with which order we are expecting those products</p>
        </div>
    </div>

    <div class="container">
        <div id="loading" class="loading">
            <div class="loading-spinner"></div>
            <p style="color: var(--color-primary); font-weight: 600;">Loading requests...</p>
        </div>

        <div id="requests-container" class="requests-grid" style="display: none;"></div>

        <div id="empty-state" class="empty-state" style="display: none;">
            <div class="empty-state-icon">ðŸ“‹</div>
            <h3>No requests found</h3>
            <p>Check back later for new CRM requests.</p>
        </div>
    </div>

    <div id="modal-overlay" class="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h3 class="modal-title">Mark Response</h3>
                <button class="close-button" onclick="closeModal()">&times;</button>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="poSearchInput">Expected with PO No.</label>
                <div class="searchable-dropdown-container">
                    <input type="text" id="poSearchInput" class="searchable-dropdown-input" placeholder="Search PO Number...">
                    <button class="search-clear-button" onclick="clearPoSearch()">Ã—</button>
                    <div id="poSearchResults" class="searchable-dropdown-results" style="display: none;"></div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="remark">Remark</label>
                <textarea id="remark" class="form-textarea" placeholder="Enter your remark..."></textarea>
            </div>
                
            <div class="modal-actions">
                <button class="btn-cancel" onclick="closeModal()">Cancel</button>
                <button id="submit-btn" class="btn-submit" onclick="submitResponse()" disabled>Submit</button>
            </div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script>
        // Global variables
        let requests = [];
        let poNumbers = [];
        let filteredPoNumbers = [];
        let selectedRequest = null;
        let selectedPoNo = '';
        let countdownIntervals = {}; // store by element ID (or generated key)

        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycby7Iwfzy98sI8UFYs6lCZZF_ESoaTzFd3UWwZJWepffBD6rueQ9TdzgLq7oE98npIwpdQ/exec';
        const GOOGLE_SHEET_PO_URL = 'https://docs.google.com/spreadsheets/d/1MPBE5EED1iN8np3oVqcn3VSAYl7M-OUXaLj9_YJogh0/gviz/tq?tqx=out:json&sheet=Requests&range=A:AL';

        document.addEventListener('DOMContentLoaded', function() {
            fetchRequests();
            fetchPoNumbers();
            setupFormValidation();
            setupSearchableDropdown();
            if (typeof setReadOnlyMode === "function") setReadOnlyMode();
        });

        async function fetchRequests() {
            const loading = document.getElementById('loading');
            const container = document.getElementById('requests-container');
            const emptyState = document.getElementById('empty-state');

            loading.style.display = 'block';
            container.style.display = 'none';
            emptyState.style.display = 'none';

            // Clear existing countdown intervals before re-rendering
            for (const key in countdownIntervals) {
                clearInterval(countdownIntervals[key]);
            }
            countdownIntervals = {};

            try {
                const response = await fetch(`${GAS_WEB_APP_URL}?action=getRequests`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const result = await response.json();
                console.log('Fetched requests response:', result);
                if (!Array.isArray(result.data)) throw new Error("Expected 'data' to be an array");
                requests = result.data;
                renderRequests();
				if (typeof setReadOnlyMode === "function") {
				  setReadOnlyMode();
				}                
            } catch (error) {
                console.error('Error fetching requests:', error);
                showToast('Error loading requests. Please try again.', 'error');
                requests = [];
                renderRequests();
            } finally {
                loading.style.display = 'none';
            }
        }

        async function fetchPoNumbers() {
            try {
                const response = await fetch(GOOGLE_SHEET_PO_URL);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const text = await response.text();
                const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
                const data = JSON.parse(jsonText);

                // Adjusted indices according to your comments
                // This filtering logic mirrors your original - adapt indices if needed.
                poNumbers = data.table.rows
                    .filter(row => row.c[8]?.v === "Done" && (!row.c[20] || row.c[20].v === ""))
                    .map(row => row.c[37]?.v)
                    .filter(value => value !== undefined && value !== null && value !== '')
                    .map(String);

                poNumbers = [...new Set(poNumbers)].sort();
                filteredPoNumbers = [...poNumbers];
                populateSearchResults();
            } catch (error) {
                console.error('Error fetching PO numbers:', error);
                showToast('Error loading PO numbers. Fallback used.', 'error');
                poNumbers = ['PO-2024-001-Fallback','PO-2024-002-Fallback','PO-2024-003-Fallback','PO-2024-004-Fallback'];
                poNumbers = [...new Set(poNumbers)].sort();
                filteredPoNumbers = [...poNumbers];
                populateSearchResults();
            }
        }

        function renderRequests() {
            const container = document.getElementById('requests-container');
            const emptyState = document.getElementById('empty-state');

            if (requests.length === 0) {
                emptyState.style.display = 'block';
                container.style.display = 'none';
                container.innerHTML = '';
                return;
            }

            container.style.display = 'grid';
            container.innerHTML = '';

            requests.forEach((request) => {
                const card = createRequestCard(request);
                // append card to DOM first
                container.appendChild(card);

                // After append, if poReceivedTimestamp dataset exists, start countdown using element reference
                if (card.dataset && card.dataset.poReceivedTimestamp) {
                    const poReceivedTimestamp = parseInt(card.dataset.poReceivedTimestamp, 10);
                    const countdownEl = card.querySelector(`#countdown-${cssSafeId(request.id)}`);
                    // only start if element found
                    if (countdownEl) {
                        startCountdown(poReceivedTimestamp, countdownEl, card);
                    } else {
                        console.warn('Countdown element not found after append for', request.id);
                    }
                }
            });
        }

        // Helper: make an ID safe (remove spaces and problematic chars)
        function cssSafeId(raw) {
            if (raw === undefined || raw === null) return '';
            return String(raw).replace(/[^a-zA-Z0-9\-_:.]/g, '_');
        }

        // Parse ISO 8601 explicitly (keeps your robust parsing)
        function parseIsoDateTime(isoString) {
            if (!isoString || typeof isoString !== 'string') return null;
            const parts = isoString.match(/(\d{4})-(\d{2})-(\d{2})T(\d{2}):(\d{2}):(\d{2})(?:\.(\d{1,3}))?Z/);
            if (!parts) {
                const nativeDate = new Date(isoString);
                if (!isNaN(nativeDate.getTime())) return nativeDate;
                return null;
            }
            const [, year, month, day, hours, minutes, seconds, milliseconds] = parts;
            const date = new Date(Date.UTC(
                parseInt(year), parseInt(month) - 1, parseInt(day),
                parseInt(hours), parseInt(minutes), parseInt(seconds),
                parseInt(milliseconds || '0')
            ));
            return date;
        }

        function createRequestCard(request) {
            const card = document.createElement('div');
            card.className = 'request-card';

            if (request.responseRemark && request.responseRemark.trim() !== '') {
                card.classList.add('highlighted');
            }

            let poReceivedTimestamp = null;
            let deadlineDisplay = '';
            if (request.poReceived) {
                const parsedDate = parseIsoDateTime(request.poReceived);
                if (parsedDate && !isNaN(parsedDate.getTime())) {
                    poReceivedTimestamp = parsedDate.getTime();
                    const deadline = poReceivedTimestamp + (24 * 60 * 60 * 1000); // +24 hours
                    // Store as dataset for later usage (so renderRequests can start countdown after append)
                    card.dataset.poReceivedTimestamp = String(poReceivedTimestamp);

                    // deadline absolute display in IST
                    deadlineDisplay = new Date(deadline).toLocaleString('en-IN', {
                        timeZone: 'Asia/Kolkata',
                        year: 'numeric',
                        month: '2-digit',
                        day: '2-digit',
                        hour: '2-digit',
                        minute: '2-digit',
                        second: '2-digit',
                        hour12: true
                    });

                    // If already overdue, mark card
                    if (Date.now() > deadline) {
                        card.classList.add('overdue-card-highlight');
                    }
                } else {
                    console.warn('Could not parse poReceived:', request.poReceived);
                }
            }

            let crmValue = request.crm || 'N/A';
            if (crmValue !== 'N/A' && (crmValue.startsWith('http://') || crmValue.startsWith('https://'))) {
                crmValue = `<a href="${crmValue}" target="_blank" style="color: var(--color-primary); text-decoration: none;">View CRM</a>`;
            }

            let productHtml = '';
            if (request.product && (request.product.startsWith('http://') || request.product.startsWith('https://'))) {
                productHtml = `
                    <div class="field-group">
                        <span class="field-label">File:</span>
                        <a href="${request.product}" target="_blank" class="view-file-button">View File</a>
                    </div>`;
            } else {
                productHtml = `
                    <div class="field-group">
                        <span class="field-label">Product:</span>
                        <div class="field-value">${request.product || 'N/A'}</div>
                    </div>`;
            }

            let poReceivedDisplay = 'N/A';
            if (poReceivedTimestamp) {
                const parsedDate = new Date(poReceivedTimestamp);
                poReceivedDisplay = parsedDate.toLocaleString('en-IN', {
                    timeZone: 'Asia/Kolkata',
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit',
                    second: '2-digit',
                    hour12: true
                });
            }

            const watermarkHtml = request.crmStatus === 'Cancel' ? '<div class="watermark">Cancelled</div>' : '';
            const buttonText = (request.responseRemark && request.responseRemark.trim() !== '') ? 'Modify Response' : 'Mark Response';

            let receivedButtonHtml = '';
            if (request.poReceived && request.poReceived.trim() !== '') {
                receivedButtonHtml = `
                    <button class="received-button" onclick="markAsReceived('${request.id}')">
                        Received
                    </button>`;
            }

            // Always show absolute deadline (if poReceived present) and a dedicated countdown field
            const deadlineHtml = poReceivedTimestamp ? `
                <div class="field-group">
                    <span class="field-label">Deadline:</span>
                    <div class="field-value" id="deadline-${cssSafeId(request.id)}">${deadlineDisplay}</div>
                </div>
                <div class="field-group">
                    <span class="field-label">Time Left:</span>
                    <div class="field-value" id="countdown-${cssSafeId(request.id)}"></div>
                </div>
            ` : '';

            card.innerHTML = `
                ${watermarkHtml}
                <div class="card-content">
                    <div class="field-group">
                        <span class="field-label">Dealer Name:</span>
                        <div class="field-value">${request.dealer || 'N/A'}</div>
                    </div>

                    ${productHtml}

                    <div class="field-group">
                        <span class="field-label">Req Dt.:</span>
                        <div class="field-value">
                          ${request.timeStamp ? new Date(request.timeStamp).toLocaleDateString('en-GB') : 'N/A'}
                        </div>
                    </div>

                    <div class="field-group">
                        <span class="field-label">Priority:</span>
                        <div class="field-value">${request.priority || 'N/A'}</div>
                    </div>

                    <div class="field-group">
                        <span class="field-label">Remark:</span>
                        <div class="field-value">${request.remark || 'N/A'}</div>
                    </div>

                    ${request.poDetail ? `
                    <div class="field-group">
                        <span class="field-label">PO:</span>
                        <div class="field-value">${request.poDetail}</div>
                    </div>` : ''}

                    <div class="field-group">
                        <span class="field-label">CRM:</span>
                        <div class="field-value">${crmValue}</div>
                    </div>

                    ${poReceivedTimestamp ? `
                        <div class="field-group">
                            <span class="field-label">PO Received:</span>
                            <div class="field-value">${poReceivedDisplay}</div>
                        </div>
                        ${deadlineHtml}
                    ` : ''}
                </div>
        
                <div class="editable">
                    <button class="action-button" onclick="openModal('${request.id}')">
                        ${buttonText}
                    </button>
                    <button class="cancel-button" onclick="cancelRequest('${request.id}')">
                        Cancel Request
                    </button>
                    ${receivedButtonHtml}
                </div>
            `;

            // don't start countdown here because card isn't appended yet â€” renderRequests will start it after append
            return card;
        }

        // Start the countdown timer. Accepts poReceivedTimestamp (ms) and an element (DOM node) or element id string
        function startCountdown(poReceivedTimestamp, countdownElementOrId, cardElement) {
            // determine the countdown DOM element
            let countdownElement = null;
            if (typeof countdownElementOrId === 'string') {
                countdownElement = document.getElementById(countdownElementOrId);
            } else {
                countdownElement = countdownElementOrId;
            }
            if (!countdownElement) {
                console.warn('Countdown element not found for', countdownElementOrId);
                return;
            }

            const deadline = poReceivedTimestamp + (24 * 60 * 60 * 1000);
            const intervalKey = countdownElement.id || ('countdown_key_' + Math.random().toString(36).slice(2));

            // clear existing interval if any
            if (countdownIntervals[intervalKey]) {
                clearInterval(countdownIntervals[intervalKey]);
            }

            const MILLIS = {
                sec: 1000,
                min: 1000 * 60,
                hour: 1000 * 60 * 60,
                day: 1000 * 60 * 60 * 24
            };

            const update = () => {
                const now = Date.now();
                const timeRemaining = deadline - now;

                if (timeRemaining <= 0) {
                    clearInterval(countdownIntervals[intervalKey]);
                    countdownElement.innerHTML = '<span class="overdue-text">Overdue</span>';
                    if (cardElement) cardElement.classList.add('overdue-card-highlight');
                    return;
                }

                const days = Math.floor(timeRemaining / MILLIS.day);
                const hours = Math.floor((timeRemaining % MILLIS.day) / MILLIS.hour);
                const minutes = Math.floor((timeRemaining % MILLIS.hour) / MILLIS.min);
                const seconds = Math.floor((timeRemaining % MILLIS.min) / MILLIS.sec);

                let countdownClass = 'countdown-green';
                if (timeRemaining < 1 * MILLIS.hour) {
                    countdownClass = 'countdown-red';
                } else if (timeRemaining < 4 * MILLIS.hour) {
                    countdownClass = 'countdown-yellow';
                }

                countdownElement.innerHTML = `<span class="${countdownClass}">` +
                    `${days > 0 ? days + 'd ' : ''}` +
                    `${String(hours).padStart(2,'0')}h ` +
                    `${String(minutes).padStart(2,'0')}m ` +
                    `${String(seconds).padStart(2,'0')}s` +
                    `</span>`;
            };

            // initial render then interval
            update();
            countdownIntervals[intervalKey] = setInterval(update, 1000);
        }

        // Modal & form logic (kept same)
        function openModal(requestId) {
            selectedRequest = requests.find(req => req.id === requestId);
            if (!selectedRequest) {
                console.error("Could not find request with ID:", requestId);
                showToast("Error opening response form. Request not found.", "error");
                return;
            }
            document.getElementById('modal-overlay').style.display = 'block';
            document.body.style.overflow = 'hidden';
            document.getElementById('poSearchInput').value = selectedRequest.expectedPoNo || '';
            selectedPoNo = selectedRequest.expectedPoNo || '';
            document.getElementById('remark').value = selectedRequest.responseRemark || '';
            populateSearchResults();
            validateForm();
        }

        function closeModal() {
            document.getElementById('modal-overlay').style.display = 'none';
            document.body.style.overflow = 'auto';
            selectedRequest = null;
            document.getElementById('poSearchResults').style.display = 'none';
        }

        function setupFormValidation() {
            const remarkInput = document.getElementById('remark');
            const poSearchInput = document.getElementById('poSearchInput');
            remarkInput.addEventListener('input', validateForm);
            poSearchInput.addEventListener('input', validateForm);
        }

        function validateForm() {
            const remark = document.getElementById('remark').value.trim();
            const isValid = selectedPoNo && remark;
            document.getElementById('submit-btn').disabled = !isValid;
        }

        function setupSearchableDropdown() {
            const poSearchInput = document.getElementById('poSearchInput');
            const poSearchResults = document.getElementById('poSearchResults');

            poSearchInput.addEventListener('input', function() {
                const searchText = this.value.toLowerCase();
                filteredPoNumbers = poNumbers.filter(po => po.toLowerCase().includes(searchText));
                populateSearchResults();
                poSearchResults.style.display = (filteredPoNumbers.length > 0 && searchText.length > 0) ? 'block' : 'none';
                if (filteredPoNumbers.length === 1 && filteredPoNumbers[0].toLowerCase() === searchText) {
                    selectedPoNo = filteredPoNumbers[0];
                } else {
                    selectedPoNo = '';
                }
                validateForm();
            });

            poSearchInput.addEventListener('focus', function() {
                const searchText = this.value.toLowerCase();
                filteredPoNumbers = poNumbers.filter(po => po.toLowerCase().includes(searchText));
                populateSearchResults();
                poSearchResults.style.display = filteredPoNumbers.length > 0 ? 'block' : 'none';
            });

            document.addEventListener('click', function(e) {
                if (!poSearchInput.contains(e.target) && !poSearchResults.contains(e.target)) {
                    poSearchResults.style.display = 'none';
                }
            });

            poSearchInput.addEventListener('keydown', function(e) {
                const resultsDivs = Array.from(poSearchResults.children);
                let currentFocus = -1;
                for (let i = 0; i < resultsDivs.length; i++) {
                    if (resultsDivs[i].classList.contains('selected')) { currentFocus = i; break; }
                }
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentFocus = (currentFocus + 1) % resultsDivs.length;
                    focusResult(resultsDivs, currentFocus);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentFocus = (currentFocus - 1 + resultsDivs.length) % resultsDivs.length;
                    focusResult(resultsDivs, currentFocus);
                } else if (e.key === 'Enter' && currentFocus > -1) {
                    e.preventDefault();
                    resultsDivs[currentFocus].click();
                }
            });
        }

        function populateSearchResults() {
            const poSearchResults = document.getElementById('poSearchResults');
            poSearchResults.innerHTML = '';
            if (filteredPoNumbers.length === 0 && document.getElementById('poSearchInput').value.length > 0) {
                const noResultDiv = document.createElement('div');
                noResultDiv.textContent = 'No matching PO numbers';
                noResultDiv.style.cursor = 'default';
                noResultDiv.style.color = 'var(--color-text-light)';
                poSearchResults.appendChild(noResultDiv);
                return;
            }
            filteredPoNumbers.forEach(po => {
                const div = document.createElement('div');
                div.textContent = po;
                div.onclick = () => selectPoNumber(po);
                poSearchResults.appendChild(div);
            });
        }

        function selectPoNumber(po) {
            document.getElementById('poSearchInput').value = po;
            selectedPoNo = po;
            document.getElementById('poSearchResults').style.display = 'none';
            validateForm();
        }

        function clearPoSearch() {
            document.getElementById('poSearchInput').value = '';
            selectedPoNo = '';
            filteredPoNumbers = [...poNumbers];
            populateSearchResults();
            document.getElementById('poSearchResults').style.display = 'none';
            validateForm();
        }

        function focusResult(resultsDivs, index) {
            resultsDivs.forEach((div, i) => {
                if (i === index) {
                    div.classList.add('selected');
                    div.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
                } else {
                    div.classList.remove('selected');
                }
            });
        }

        async function submitResponse() {
            const formData = {
                expectedPoNo: selectedPoNo,
                responseRemark: document.getElementById('remark').value.trim(),
            };
            if (!selectedRequest) { showToast('No request selected', 'error'); return; }
            const submissionData = { action: 'submitResponse', id: selectedRequest.id, ...formData };
            const submitBtn = document.getElementById('submit-btn');
            const originalBtnText = submitBtn.textContent;
            submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
            try {
                console.log('Submitting:', submissionData);
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(submissionData)
                });
                showToast('Response submitted successfully!', 'success');
                closeModal();
                fetchRequests();
            } catch (error) {
                console.error('Error submitting response:', error);
                showToast('Error submitting response. Please try again.', 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = originalBtnText;
            }
        }

        async function cancelRequest(requestId) {
            const requestToCancel = requests.find(req => req.id === requestId);
            if (!requestToCancel) { showToast("Error cancelling request. Request not found.", "error"); return; }
            if (!confirm(`Are you sure you want to cancel the request for "${requestToCancel.dealer}"?`)) return;
            const submissionData = { action: 'cancelRequest', id: requestId };
            try {
                const cardElement = document.querySelector(`.cancel-button[onclick*="${requestId}"]`).closest('.request-card');
                const allButtons = cardElement.querySelectorAll('.editable button');
                allButtons.forEach(btn => btn.disabled = true);
                const cancelButton = cardElement.querySelector('.cancel-button');
                cancelButton.textContent = 'Cancelling...';
                console.log('Cancelling request:', submissionData);
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(submissionData)
                });
                showToast('Request cancelled successfully!', 'success');
                fetchRequests();
            } catch (error) {
                console.error('Error cancelling request:', error);
                showToast('Error cancelling request. Please try again.', 'error');
                const cardElement = document.querySelector(`.cancel-button[onclick*="${requestId}"]`).closest('.request-card');
                const allButtons = cardElement.querySelectorAll('.editable button');
                allButtons.forEach(btn => btn.disabled = false);
                cardElement.querySelector('.cancel-button').textContent = 'Cancel Request';
            }
        }

        async function markAsReceived(requestId) {
            const requestToMark = requests.find(req => req.id === requestId);
            if (!requestToMark) { showToast("Error processing request. Request not found.", "error"); return; }
            if (!confirm(`Are you sure you want to mark the request for "${requestToMark.dealer}" as received?`)) return;
            const submissionData = { action: 'poReceived', id: requestId };
            try {
                const cardElement = document.querySelector(`.received-button[onclick*="${requestId}"]`).closest('.request-card');
                const allButtons = cardElement.querySelectorAll('.editable button');
                allButtons.forEach(btn => btn.disabled = true);
                const receivedButton = cardElement.querySelector('.received-button');
                receivedButton.textContent = 'Processing...';
                console.log('Marking as received:', submissionData);
                await fetch(GAS_WEB_APP_URL, {
                    method: 'POST', mode: 'no-cors', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(submissionData)
                });
                showToast('Request marked as received!', 'success');
                fetchRequests();
            } catch (error) {
                console.error('Error marking as received:', error);
                showToast('Error marking request as received. Please try again.', 'error');
                const cardElement = document.querySelector(`.received-button[onclick*="${requestId}"]`).closest('.request-card');
                const allButtons = cardElement.querySelectorAll('.editable button');
                allButtons.forEach(btn => btn.disabled = false);
                cardElement.querySelector('.received-button').textContent = 'Received';
            }
        }

        document.getElementById('modal-overlay').addEventListener('click', function(e){
            if (e.target === this) closeModal();
        });
        document.addEventListener('keydown', function(e){
            if (e.key === 'Escape' && document.getElementById('modal-overlay').style.display === 'block') closeModal();
        });

        function showToast(message, type = 'success', duration = 3000) {
            const toastContainer = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            toastContainer.appendChild(toast);
            void toast.offsetWidth;
            toast.classList.add('show');
            setTimeout(() => {
                toast.classList.remove('show');
                toast.addEventListener('transitionend', () => toast.remove());
            }, duration);
        }
    </script>

    <script src="https://ntwoods.github.io/ordertodispatch/js/viewOnly.js"></script>
</body>
</html>
