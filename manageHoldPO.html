<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hold Orders Management</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for clean typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        /* Custom CSS for White & Blue Theme */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #F0F4F8; /* Light blue-gray background */
            color: #334155; /* Dark slate gray for general text */
        }
        .container {
            max-width: 96rem; /* Equivalent to max-w-6xl in Tailwind */
            margin-left: auto;
            margin-right: auto;
            padding: 2rem; /* p-8 */
        }
        .header h1 {
            color: #1E40AF; /* Darker blue for main heading */
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); /* Subtle shadow */
        }
        .order-card {
            background-color: #FFFFFF; /* White card background */
            border: 1px solid #BFDBFE; /* Light blue border */
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08); /* Soft shadow */
            transition: all 0.3s ease-in-out;
        }
        .order-card:hover {
            border-color: #93C5FD; /* Brighter blue on hover */
            transform: translateY(-5px) scale(1.02); /* Lift and slightly enlarge */
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }
        .order-card h3 {
            color: #1D4ED8; /* Medium blue for supplier name */
        }
        .order-card p {
            color: #4B5563; /* Gray for card text */
        }
        .order-card .font-medium {
            color: #2563EB; /* Bright blue for labels like 'Hold Until' */
        }
        .btn-approve {
            background-color: #10B981; /* Green for approve */
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-approve:hover {
            background-color: #059669; /* Darker green on hover */
            transform: scale(1.05);
        }
        .btn-cancel {
            background-color: #EF4444; /* Red for cancel */
            transition: background-color 0.2s ease-in-out, transform 0.2s ease-in-out;
        }
        .btn-cancel:hover {
            background-color: #DC2626; /* Darker red on hover */
            transform: scale(1.05);
        }

        /* Message Box / Toast Notification */
        .toast-message-box {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.8); /* Start smaller */
            background-color: #1F2937; /* Dark gray background */
            color: white;
            padding: 24px 32px;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.3);
            z-index: 1000;
            display: none; /* Hidden by default */
            max-width: 90%;
            text-align: center;
            opacity: 0; /* Start invisible */
            transition: all 0.3s ease-out;
            border: 1px solid #4B5563;
        }
        .toast-message-box.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .toast-message-box button {
            background-color: #3B82F6; /* Blue button */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            transition: background-color 0.2s ease-in-out;
        }
        .toast-message-box button:hover {
            background-color: #2563EB; /* Darker blue on hover */
        }

        /* Loading Spinner */
        .loader {
            border: 6px solid #E5E7EB; /* Light gray */
            border-top: 6px solid #3B82F6; /* Blue */
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 20px auto; /* Center the loader */
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Success Notification */
        .success-notification {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.5);
            background-color: #10B981; /* Green background */
            color: white;
            padding: 30px 40px;
            border-radius: 15px;
            box-shadow: 0 15px 30px rgba(0,0,0,0.4);
            z-index: 1001;
            display: none;
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55); /* Springy animation */
            text-align: center;
        }
        .success-notification.show {
            opacity: 1;
            transform: translate(-50%, -50%) scale(1);
        }
        .success-notification i {
            font-size: 3rem;
            margin-bottom: 15px;
            animation: bounceIn 0.6s forwards;
        }
        .success-notification p {
            font-size: 1.25rem;
            font-weight: 600;
        }

        @keyframes bounceIn {
            0% { transform: scale(0.1); opacity: 0; }
            60% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body class="min-h-screen">
    <div class="container p-8">
        <header class="header text-center mb-10">
            <h1 class="text-4xl font-bold mb-2 drop-shadow-lg">Hold Orders Management</h1>
            <p class="text-gray-600 text-lg">Review and manage pending hold orders.</p>
        </header>

        <!-- Loading, Error, and No Orders messages -->
        <div id="status-message" class="text-center text-blue-600 text-xl mt-8">
            <div class="loader"></div>
            Loading orders...
        </div>

        <!-- Container for order cards -->
        <div id="orders-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 mt-8">
            <!-- Order cards will be dynamically inserted here by JavaScript -->
        </div>
    </div>

    <!-- Custom Message Box / Toast Notification -->
    <div id="toast-message-box" class="toast-message-box">
        <p id="toast-message-content" class="mb-4"></p>
        <button onclick="hideToastMessageBox()">OK</button>
    </div>

    <!-- Success Notification -->
    <div id="success-notification" class="success-notification">
        <i class="fas fa-check-circle"></i>
        <p id="success-message-content">Order Cancelled Successfully!</p>
    </div>

    <script>
        // Define the API URL for fetching and posting data
        const API_URL = "https://script.google.com/macros/s/AKfycbxmknmN_A0jdyu8B489qcb1UfVSwyG7sGvRs3LPCj6647GyYU2oL0sIf7GaKuLodYfFeg/exec";
        const ordersContainer = document.getElementById('orders-container');
        const statusMessage = document.getElementById('status-message');
        const toastMessageBox = document.getElementById('toast-message-box');
        const toastMessageContent = document.getElementById('toast-message-content');
        const successNotification = document.getElementById('success-notification');
        const successMessageContent = document.getElementById('success-message-content');

        let allOrders = []; // To store all fetched orders for easy lookup

        /**
         * Displays a custom toast message box.
         * @param {string} message - The message to display.
         */
        function showToastMessageBox(message) {
            toastMessageContent.textContent = message;
            toastMessageBox.style.display = 'block';
            setTimeout(() => {
                toastMessageBox.classList.add('show');
            }, 10); // Small delay to trigger transition
        }

        /**
         * Hides the custom toast message box.
         */
        function hideToastMessageBox() {
            toastMessageBox.classList.remove('show');
            setTimeout(() => {
                toastMessageBox.style.display = 'none';
            }, 300); // Match transition duration
        }

        /**
         * Displays a success notification at the center of the window.
         * @param {string} message - The success message to display.
         */
        function showSuccessNotification(message) {
            successMessageContent.textContent = message;
            successNotification.style.display = 'block';
            setTimeout(() => {
                successNotification.classList.add('show');
            }, 10);

            // Automatically hide after 3 seconds
            setTimeout(() => {
                hideSuccessNotification();
            }, 3000);
        }

        /**
         * Hides the success notification.
         */
        function hideSuccessNotification() {
            successNotification.classList.remove('show');
            setTimeout(() => {
                successNotification.style.display = 'none';
            }, 400); // Match transition duration
        }

        /**
         * Formats a date string into 'dd-mmm-yyyy' format.
         * @param {string} dateString - The date string to format (e.g., '2025-06-27T00:00:00.000Z').
         * @returns {string} Formatted date string or 'N/A' if invalid.
         */
        function formatHoldUntilDate(dateString) {
            if (!dateString) return 'N/A';
            try {
                const date = new Date(dateString);
                // Check if the date is valid
                if (isNaN(date.getTime())) {
                    return 'N/A';
                }
                const options = { day: '2-digit', month: 'short', year: 'numeric' };
                return date.toLocaleDateString('en-GB', options).replace(/ /g, '-');
            } catch (e) {
                console.error("Error formatting date:", e);
                return 'N/A';
            }
        }

        /**
         * Fetches order data from the Google Script API.
         */
        async function fetchOrders() {
            statusMessage.innerHTML = '<div class="loader"></div> Loading orders...';
            statusMessage.className = 'text-center text-blue-600 text-xl mt-8'; // Reset class for loading
            ordersContainer.innerHTML = ''; // Clear previous orders

            try {
                const response = await fetch(API_URL);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                const data = await response.json();

                // Assuming data is an array or an object with a 'data' key
                allOrders = Array.isArray(data) ? data : (data.data || []);

                if (allOrders.length === 0) {
                    statusMessage.innerHTML = '<i class="fas fa-info-circle text-gray-500 mr-2"></i> No hold orders found.';
                    statusMessage.className = 'text-center text-gray-500 text-xl mt-8';
                    return;
                }

                statusMessage.style.display = 'none'; // Hide status message once orders are loaded
                renderOrders(allOrders); // Render the fetched orders
            } catch (error) {
                console.error("Failed to fetch orders:", error);
                statusMessage.innerHTML = `<i class="fas fa-exclamation-triangle text-red-500 mr-2"></i> Failed to load orders. Please try again later. Error: ${error.message}`;
                statusMessage.className = 'text-center text-red-500 text-xl mt-8 p-4 bg-red-100 border border-red-300 rounded-lg';
            }
        }

        /**
         * Renders the order cards in the DOM.
         * @param {Array} orders - An array of order objects.
         */
        function renderOrders(orders) {
            ordersContainer.innerHTML = ''; // Clear previous content
            orders.forEach(order => {
                const orderCard = document.createElement('div');
                orderCard.className = 'order-card p-6 rounded-lg shadow-lg transform hover:scale-105 relative';
                orderCard.innerHTML = `
                    <div class="flex justify-between items-start mb-2">
                        <h3 class="text-xl font-semibold">${order.supplierName || 'N/A'}</h3>
                        <p class="text-xs text-gray-500 font-medium ml-4 mt-1">PO No.: ${order.purchaseOrderNumber || 'N/A'}</p>
                    </div>
                    <p class="text-sm mb-1">
                        <span class="font-medium">Hold Until:</span> ${formatHoldUntilDate(order.holdUntil)}
                    </p>
                    <p class="text-sm mb-4">
                        <span class="font-medium">Remark:</span> ${order.holdRemark || 'No remark'}
                    </p>
                    <div class="flex justify-end space-x-3">
                        <button class="btn-approve text-white py-2 px-4 rounded-md text-sm font-semibold shadow-md flex items-center"
                                data-order-id="${order.timestamp}" data-po-number="${order.purchaseOrderNumber}" data-action="Approve">
                                <i class="fas fa-check-circle mr-2"></i> Approve
                        </button>
                        <button class="btn-cancel text-white py-2 px-4 rounded-md text-sm font-semibold shadow-md flex items-center"
                                data-order-id="${order.timestamp}" data-po-number="${order.purchaseOrderNumber}" data-action="Cancel">
                                <i class="fas fa-times-circle mr-2"></i> Cancel
                        </button>
                    </div>
                `;
                ordersContainer.appendChild(orderCard);
            });

            // Add event listeners to the dynamically created buttons
            addActionListener();
        }

        /**
         * Adds click event listeners to all Approve and Cancel buttons.
         */
function addActionListener() {
    document.querySelectorAll('.btn-approve, .btn-cancel').forEach(button => {
        button.addEventListener('click', (event) => {
            const orderId = event.target.dataset.orderId || event.target.closest('button').dataset.orderId;
            const purchaseOrderNumber = event.target.dataset.purchaseOrderNumber || event.target.closest('button').dataset.purchaseOrderNumber;
            const actionType = event.target.dataset.action || event.target.closest('button').dataset.action;
            // Corrected line already applied in the provided file:
            handleAction(orderId, purchaseOrderNumber, actionType);
        });
    });
}
        /**
         * Handles the Approve or Cancel action for an order.
         * @param {string} orderId - The unique identifier for the order (timestamp).
         * @param {string} poNumber - The Purchase Order Number.
         * @param {string} actionType - 'Approve' or 'Cancel'.
         */
/**
         * Handles the Approve or Cancel action for an order.
         * @param {string} orderId - The unique identifier for the order (timestamp).
         * @param {string} purchaseOrderNumber - The Purchase Order Number.
         * @param {string} actionType - 'Approve' or 'Cancel'.
         */
async function handleAction(orderId, purchaseOrderNumber, actionType) {
    showToastMessageBox(`Sending ${actionType} request for Order ID: ${orderId}...`);

    try {
        const payload = {
            action: actionType,
            orderId: orderId,
            purchaseOrderNumber: purchaseOrderNumber
        };

        const response = await fetch(API_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: new URLSearchParams(payload).toString(),
        });

        hideToastMessageBox();
        showSuccessNotification(`Order ${orderId} has been ${actionType}d successfully!`);
        await fetchOrders();
    } catch (error) {
        console.error(`Failed to ${actionType} order ${orderId}:`, error);
        hideToastMessageBox();
        showToastMessageBox(`Failed to ${actionType} order ${orderId}. Error: ${error.message}`);
    }
}
        // Fetch orders when the window loads
        window.onload = fetchOrders;
    </script>
</body>
</html>
