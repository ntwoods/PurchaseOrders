<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Order Categories Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind config: add Poppins
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { poppins: ['Poppins', 'sans-serif'] },
            colors: {
              forest: {
                600: '#166534',
                700: '#14532d',
                800: '#0f3b20'
              },
              crimson: {
                500: '#dc2626',
                600: '#b91c1c'
              },
              sky: {
                500: '#0ea5e9'
              }
            },
            boxShadow: {
              'neon': '0 6px 18px rgba(16,185,129,0.14), inset 0 -6px 20px rgba(0,0,0,0.06)'
            }
          }
        }
      }
    </script>

    <script src="https://unpkg.com/feather-icons"></script>

    <style>
      :root { --card-shadow: 0 10px 30px rgba(2,6,23,0.06); }
      body { font-family: Poppins, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }

      /* 3D green button */
      .btn-3d-green {
        background: linear-gradient(180deg, #16a34a 0%, #15803d 100%);
        border-radius: 12px;
        padding: .6rem 1rem;
        color: white;
        font-weight: 700;
        box-shadow: 0 8px 0 rgba(3, 105, 64, 0.12), 0 18px 30px rgba(16,24,40,0.08);
        transform: translateY(0);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .btn-3d-green:active { transform: translateY(3px); box-shadow: 0 4px 0 rgba(3,105,64,0.08); }

      /* 3D crimson */
      .btn-3d-red {
        background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        border-radius: 12px;
        padding: .6rem 1rem;
        color: white;
        font-weight: 700;
        box-shadow: 0 8px 0 rgba(180, 20, 20, 0.12), 0 18px 30px rgba(16,24,40,0.08);
        transform: translateY(0);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .btn-3d-red:active { transform: translateY(3px); box-shadow: 0 4px 0 rgba(120, 18, 18, 0.08); }

      .fade-in { animation: fadeIn .28s ease both; }
      @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform:none;} }

      /* scrollable cards container subtle style */
      .cards-scroll { scrollbar-width: thin; }
      .cards-scroll::-webkit-scrollbar { height:8px; }
      .cards-scroll::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.12); border-radius: 6px; }

      /* small badge */
      .badge { font-size: 12px; background: rgba(15,23,42,0.06); padding: 4px 8px; border-radius: 999px; }

      /* Pop-up container */
      .popup {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.4s ease-out;
      }
      .popup.is-visible { transform: translateX(0); }
      
      /* New loader styles */
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #14532d;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        animation: spin 1s linear infinite;
        margin-right: 8px;
        display: none; /* Initially hidden */
      }
      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }
    </style>
  </head>
  <body class="bg-gradient-to-b from-neutral-50 to-neutral-100 min-h-screen text-slate-900">

    <div class="max-w-7xl mx-auto px-6 py-10">
      <nav class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-forest-700 rounded-lg flex items-center justify-center shadow-neon text-white font-bold">NT</div>
          <div>
            <h1 class="text-2xl font-semibold">Categories Dashboard</h1>
            <p class="text-sm text-slate-500">Review and update category order status</p>
          </div>
        </div>

        <button id="refreshBtn" class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm flex items-center">
            <span id="refreshLoader" class="loader"></span>
            Refresh
        </button>
      </nav>

      <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-3">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <input id="search" type="search" placeholder="Search categories..." class="px-4 py-2 rounded-lg border w-72" />
            </div>
            <div class="text-sm text-slate-500">Status: <span id="statusSummary">Listening</span></div>
          </div>

          <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 cards-scroll max-h-[60vh] overflow-auto p-2">
            </div>
        </div>
      </section>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
      <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-lg">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 id="modalTitle" class="text-lg font-semibold">Add remark</h3>
            <p id="modalSubtitle" class="text-sm text-slate-500">Provide a remark before marking order as pending</p>
          </div>
          <button id="modalClose" class="text-slate-400 hover:text-slate-600">✕</button>
        </div>
        <textarea id="remarkInput" rows="5" class="w-full border rounded-md p-3" placeholder="Type remark... (required)"></textarea>
        <div class="mt-4 flex items-center justify-end gap-3">
          <button id="modalCancel" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button id="modalDone" class="btn-3d-red" disabled>
            <span id="doneLoader" class="hidden">...</span>
            <span id="doneText">Done</span>
          </button>
        </div>
      </div>
    </div>

    <div id="pendingPopup" class="popup hidden p-5 flex-col">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold text-sky-500 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12" y2="16"></line></svg>
          Pending Orders
        </h4>
        <button id="dismissPopup" class="text-sm text-slate-500 hover:text-slate-700">Dismiss</button>
      </div>
      <ul id="pendingList" class="text-sm text-slate-700 space-y-2">
        </ul>
      <div id="noPendingMessage" class="text-xs text-slate-400 mt-2 hidden">No pending orders.</div>
    </div>
    
    <div id="newPendingCategories" class="fixed top-24 right-6 p-4 bg-white rounded-lg shadow-xl hidden">
        <h4 class="text-sm font-semibold mb-2">New Pending Categories</h4>
        <div id="pendingTableContainer" class="max-h-40 overflow-y-auto">
            <table class="table-auto w-full text-xs text-left">
                <tbody id="pendingTableBody">
                </tbody>
            </table>
        </div>
        <div id="noNewPendingMessage" class="text-xs text-slate-400 mt-2 text-center hidden">No new categories.</div>
    </div>
    
    <script>
      // ------------------ Configuration ------------------
      const API_URL = 'https://script.google.com/macros/s/AKfycbza9ne-1hmyL6nkwuo7USvOXZWAw9qgVWgz1AFtBZ4B_oSMUBwlsL8AEcqSBPDcjmmc/exec';
      const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1MPBE5EED1iN8np3oVqcn3VSAYl7M-OUXaLj9_YJogh0/gviz/tq?tqx=out:json&sheet=MissedIMSReq';
      const NEW_PENDING_API_URL = 'https://script.google.com/macros/s/AKfycbz1j7pFMggtq2yzjCI9izJ4Xf8itZWc6E0c3BEEkJYlNRX9JdjzhMwJ0dY8rr1kOrHN/exec';

      // State
      let categories = [];
      const statusMap = {};
      const createdCategoriesToday = new Set();
      let pendingCategoriesToday = [];
      let suppressUntil = 0;

      // Elements
      const cardsEl = document.getElementById('cards');
      const statusSummaryEl = document.getElementById('statusSummary');
      const searchEl = document.getElementById('search');

      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalClose = document.getElementById('modalClose');
      const modalCancel = document.getElementById('modalCancel');
      const modalDone = document.getElementById('modalDone');
      const remarkInput = document.getElementById('remarkInput');
      const doneText = document.getElementById('doneText');
      const doneLoader = document.getElementById('doneLoader');
      
      const refreshBtn = document.getElementById('refreshBtn');
      const refreshLoader = document.getElementById('refreshLoader');
      
      const pendingPopup = document.getElementById('pendingPopup');
      const pendingList = document.getElementById('pendingList');
      const dismissPopupBtn = document.getElementById('dismissPopup');
      const noPendingMessage = document.getElementById('noPendingMessage');
      
      const newPendingCategoriesEl = document.getElementById('newPendingCategories');
      const pendingTableBodyEl = document.getElementById('pendingTableBody');
      const noNewPendingMessageEl = document.getElementById('noNewPendingMessage');

      let activePendingCategory = null;

      // ------------------ Helpers ------------------
      function combineAndDedupe(a = [], b = []){
        const combined = new Set();
        a.concat(b).forEach(item => {
          const t = String(item).trim();
          if (t) combined.add(t);
        });
        return [...combined];
      }

      function escapeHtml(str){ return String(str).replace(/[&<>\"']/g, (s)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[s]); }

      function isToday(timestamp) {
        if (!timestamp) return false;
        const date = new Date(timestamp);
        if (isNaN(date.getTime())) return false; // Check for invalid date
        const today = new Date();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
      }

      function setStatusText(t){ statusSummaryEl.textContent = t; }
      
      function showButtonProcessing(btn, textSpan, loaderSpan) {
          btn.disabled = true;
          textSpan.classList.add('hidden');
          loaderSpan.classList.remove('hidden');
      }

      function hideButtonProcessing(btn, textSpan, loaderSpan) {
          btn.disabled = false;
          textSpan.classList.remove('hidden');
          loaderSpan.classList.add('hidden');
      }
      
      function showSuccessMessage(message) {
          const successDiv = document.createElement('div');
          successDiv.className = 'fixed top-24 right-6 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg fade-in';
          successDiv.textContent = message;
          document.body.appendChild(successDiv);
          setTimeout(() => {
              successDiv.classList.add('hidden');
              setTimeout(() => successDiv.remove(), 500);
          }, 3000);
      }
      
      // ------------------ UI Rendering ------------------
      function createCard(category){
        const container = document.createElement('div');
        container.className = 'p-4 bg-white rounded-xl shadow hover:shadow-md transition fade-in';
        container.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600 font-medium">${category.slice(0,2).toUpperCase()}</div>
            <div>
              <div class="font-semibold">${escapeHtml(category)}</div>
              <div class="text-xs text-slate-400 mt-1">Category</div>
            </div>
          </div>
          <div class="mt-4 flex items-center gap-3 justify-between">
            <button class="btn-3d-green" onclick="handleYes('${escapeHtml(category)}', this)">
              <span>Yes</span>
            </button>
            <button class="btn-3d-red" onclick="openPendingModal('${escapeHtml(category)}')">No</button>
            <div class="badge">${statusMap[category] ? statusMap[category] : 'new'}</div>
          </div>
        `;
        return container;
      }

      function renderCards(filterText = ''){
        cardsEl.innerHTML = '';
        const filtered = categories.filter(c => c.toLowerCase().includes(filterText.toLowerCase()));
        if (filtered.length === 0) {
          cardsEl.innerHTML = '<div class="col-span-full p-6 text-center text-slate-500 bg-white rounded-xl shadow">No new categories to show.</div>';
          return;
        }
        filtered.forEach(cat => cardsEl.appendChild(createCard(cat)));
      }

      function renderPendingPopup(){
        pendingList.innerHTML = '';
        if(pendingCategoriesToday && pendingCategoriesToday.length > 0) {
          const deduped = Array.from(new Set(pendingCategoriesToday.map(c => String(c).trim()).filter(Boolean)));
          deduped.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'p-2 bg-neutral-100 rounded-md flex items-center gap-2';
            li.innerHTML = `<span class="w-2 h-2 bg-sky-500 rounded-full"></span>${escapeHtml(cat)}`;
            pendingList.appendChild(li);
          });
          noPendingMessage.classList.add('hidden');
          pendingPopup.classList.remove('hidden');
          setTimeout(() => pendingPopup.classList.add('is-visible'), 50);
        } else {
          noPendingMessage.classList.remove('hidden');
          pendingPopup.classList.remove('is-visible');
          setTimeout(() => pendingPopup.classList.add('hidden'), 400); // Wait for transition
        }
      }
      
      function renderNewPendingTable(data) {
          pendingTableBodyEl.innerHTML = '';
          if (data && data.values && data.values.length > 0) {
              data.values.forEach(category => {
                  const row = document.createElement('tr');
                  row.className = 'hover:bg-neutral-50';
                  row.innerHTML = `<td class="p-2">${escapeHtml(category)}</td>`;
                  pendingTableBodyEl.appendChild(row);
              });
              noNewPendingMessageEl.classList.add('hidden');
              newPendingCategoriesEl.classList.remove('hidden');
          } else {
              noNewPendingMessageEl.classList.remove('hidden');
              newPendingCategoriesEl.classList.add('hidden');
          }
      }

      // ------------------ Data Fetching (direct from Sheets) ------------------
      async function fetchSheetPendingCategories(){
        try {
          const res = await fetch(SPREADSHEET_URL);
          if (!res.ok) throw new Error('Sheet fetch failed');
          const text = await res.text();
          const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
          const data = JSON.parse(jsonText);
          const rows = data.table && data.table.rows ? data.table.rows : [];

          const pending = [];
          const createdToday = new Set();

          rows.forEach(row => {
            const cells = row.c || [];
            // cells[0] -> timestamp, cells[1] -> category, cells[2] -> status
            const rawTs = (cells[0] && cells[0].f) ? cells[0].f : null;
            const category = (cells[1] && cells[1].v) ? String(cells[1].v).trim() : null;
            const status = (cells[2] && cells[2].v) ? String(cells[2].v).trim().toLowerCase() : null;

            if (!category || !status) return;

            const tsDate = new Date(rawTs);
            if (isNaN(tsDate.getTime())) return;

            if (isToday(tsDate)){
              if (status === 'created') createdToday.add(category);
              if (status === 'pending') pending.push(category);
            }
          });

          return { pending: Array.from(new Set(pending)), createdToday };

        } catch (err) {
          console.error('Failed to fetch sheet', err);
          return { pending: [], createdToday: new Set() };
        }
      }
      
      async function fetchNewPendingCategories() {
          try {
              const res = await fetch(NEW_PENDING_API_URL);
              if (!res.ok) throw new Error('Failed to fetch new pending categories');
              const data = await res.json();
              renderNewPendingTable(data);
          } catch (err) {
              console.error('Failed to fetch new pending categories', err);
              renderNewPendingTable(null);
          }
      }

      // ------------------ Main fetch that populates dashboard categories ------------------
      async function fetchMainCategories(){
        refreshLoader.style.display = 'block';
        setStatusText('Loading...');
        try{
          const apiRes = await fetch(API_URL);
          if (!apiRes.ok) throw new Error('Network error from Apps Script API');
          const apiData = await apiRes.json();
          const fetchedCategories = combineAndDedupe(apiData.fromColumnB || [], apiData.fromColumnG || []);

          const { createdToday } = await fetchSheetPendingCategories();

          // Filter out categories that are already marked 'created' today
          categories = fetchedCategories.filter(cat => !createdToday.has(cat));

          renderCards(searchEl.value);
          setStatusText('Loaded');
          refreshLoader.style.display = 'none';
        }catch(err){
          console.error(err);
          setStatusText('Failed to load');
          cardsEl.innerHTML = `<div class="col-span-full p-6 text-center text-red-600 bg-white rounded-xl shadow">Failed to fetch categories — check console.</div>`;
          refreshLoader.style.display = 'none';
        }
      }

      // ------------------ Popup / interval logic ------------------
      let popupIntervalId = null;

      async function checkAndShowPopup(){
        try{
          const { pending } = await fetchSheetPendingCategories();
          pendingCategoriesToday = pending || [];
          renderPendingPopup();

          if (pendingCategoriesToday.length > 0 && Date.now() > suppressUntil) {
            pendingPopup.classList.remove('hidden');
            setTimeout(() => pendingPopup.classList.add('is-visible'), 60);
          } else {
            pendingPopup.classList.remove('is-visible');
            setTimeout(()=> pendingPopup.classList.add('hidden'), 400);
          }

        }catch(err){
          console.error('Popup check failed', err);
        }
      }

      // ------------------ Events / Actions ------------------
      async function handleYes(category, button){
        const originalContent = button.innerHTML;
        button.innerHTML = `
          <div class="flex items-center justify-center">
              <div class="loader-inline"></div>
          </div>
        `;
        button.disabled = true;

        statusMap[category] = 'sending';
        try{
          const payload = { category, status: 'created', remark: '' };
          await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          statusMap[category] = 'created';
          showSuccessMessage('Category marked as created successfully!');
          window.location.reload();
        }catch(e){
          console.error(e);
          statusMap[category] = 'error';
          alert('Failed to send. Check console for details.');
          button.innerHTML = originalContent;
          button.disabled = false;
        }
      }

      function openPendingModal(category){
        activePendingCategory = category;
        modalTitle.textContent = `Pending remark — ${category}`;
        remarkInput.value = '';
        modalDone.setAttribute('disabled','');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        remarkInput.focus();
      }

      function closeModal(){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        activePendingCategory = null;
      }

      remarkInput.addEventListener('input', ()=>{
        const val = remarkInput.value.trim();
        if (val.length > 0) modalDone.removeAttribute('disabled'); else modalDone.setAttribute('disabled','');
      });

      modalClose.addEventListener('click', closeModal);
      modalCancel.addEventListener('click', closeModal);
      dismissPopupBtn.addEventListener('click', () => {
        // Set a timestamp to prevent the popup from immediately re-showing
        suppressUntil = Date.now() + 20000;
        pendingPopup.classList.remove('is-visible');
        setTimeout(() => pendingPopup.classList.add('hidden'), 400); // Wait for transition
      });
      modalDone.addEventListener('click', async ()=>{
        const remark = remarkInput.value.trim();
        if (!remark) return;
        
        showButtonProcessing(modalDone, doneText, doneLoader);
        
        const category = activePendingCategory;
        statusMap[category] = 'sending';
        try{
          const payload = { category, status: 'pending', remark };
          await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          statusMap[category] = 'pending';
          closeModal();
          showSuccessMessage('Category marked as pending successfully!');
          window.location.reload();
        }catch(e){
          console.error(e);
          statusMap[category] = 'error';
          alert('Failed to send pending remark. Check console.');
          hideButtonProcessing(modalDone, doneText, doneLoader);
          renderCards(searchEl.value);
        }
      });

      searchEl.addEventListener('input', ()=> renderCards(searchEl.value));
      refreshBtn.addEventListener('click', fetchMainCategories);

      // Initial load & periodic updates
      (async function init(){
        await fetchMainCategories();
        await fetchNewPendingCategories();
        // run immediately then every 20 seconds to show popup with pending categories
        await checkAndShowPopup();
        popupIntervalId = setInterval(checkAndShowPopup, 20000);
      })();

      document.addEventListener('DOMContentLoaded', ()=>{ try { feather.replace() } catch(e){} });
    </script>
  </body>
</html>
