<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Order Categories Dashboard</title>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700;800&display=swap" rel="stylesheet">

    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      // Tailwind config: add Poppins
      tailwind.config = {
        theme: {
          extend: {
            fontFamily: { poppins: ['Poppins', 'sans-serif'] },
            colors: {
              forest: {
                600: '#166534',
                700: '#14532d',
                800: '#0f3b20'
              },
              crimson: {
                500: '#dc2626',
                600: '#b91c1c'
              },
              sky: {
                500: '#0ea5e9'
              }
            },
            boxShadow: {
              'neon': '0 6px 18px rgba(16,185,129,0.14), inset 0 -6px 20px rgba(0,0,0,0.06)'
            }
          }
        }
      }
    </script>

    <script src="https://unpkg.com/feather-icons"></script>

    <style>
      :root { --card-shadow: 0 10px 30px rgba(2,6,23,0.06); }
      body { font-family: Poppins, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; }

      /* 3D green button */
      .btn-3d-green {
        background: linear-gradient(180deg, #16a34a 0%, #15803d 100%);
        border-radius: 12px;
        padding: .6rem 1rem;
        color: white;
        font-weight: 700;
        box-shadow: 0 8px 0 rgba(3, 105, 64, 0.12), 0 18px 30px rgba(16,24,40,0.08);
        transform: translateY(0);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .btn-3d-green:active { transform: translateY(3px); box-shadow: 0 4px 0 rgba(3,105,64,0.08); }

      /* 3D crimson */
      .btn-3d-red {
        background: linear-gradient(180deg, #ef4444 0%, #dc2626 100%);
        border-radius: 12px;
        padding: .6rem 1rem;
        color: white;
        font-weight: 700;
        box-shadow: 0 8px 0 rgba(180, 20, 20, 0.12), 0 18px 30px rgba(16,24,40,0.08);
        transform: translateY(0);
        transition: transform 120ms ease, box-shadow 120ms ease;
      }
      .btn-3d-red:active { transform: translateY(3px); box-shadow: 0 4px 0 rgba(120, 18, 18, 0.08); }

      .fade-in { animation: fadeIn .28s ease both; }
      @keyframes fadeIn { from { opacity:0; transform: translateY(6px);} to { opacity:1; transform:none;} }

      /* scrollable cards container subtle style */
      .cards-scroll { scrollbar-width: thin; }
      .cards-scroll::-webkit-scrollbar { height:8px; }
      .cards-scroll::-webkit-scrollbar-thumb { background: rgba(15,23,42,0.12); border-radius: 6px; }

      /* small badge */
      .badge { font-size: 12px; background: rgba(15,23,42,0.06); padding: 4px 8px; border-radius: 999px; }

      /* Pop-up container */
      .popup {
        position: fixed;
        top: 20px;
        right: 20px;
        max-width: 350px;
        background: white;
        border-radius: 12px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        z-index: 1000;
        transform: translateX(120%);
        transition: transform 0.4s ease-out, opacity 0.3s ease;
        opacity: 0;
      }
      .popup.is-visible { transform: translateX(0); opacity: 1; }
    </style>
  </head>
  <body class="bg-gradient-to-b from-neutral-50 to-neutral-100 min-h-screen text-slate-900">   
  <!-- Pending categories pop-up -->
<div id="pendingPopup" class="popup hidden p-5 flex-col">
  <div class="flex items-center justify-between mb-3">
    <h4 class="text-lg font-semibold text-sky-500 flex items-center gap-2">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12" y2="16"></line></svg>
      Pending Orders
    </h4>
    <button id="dismissPopup" class="text-sm text-slate-500 hover:text-slate-700">Dismiss</button>
  </div>
  <ul id="pendingList" class="text-sm text-slate-700 space-y-2">
    <!-- List items injected here -->
  </ul>
  <div id="noPendingMessage" class="text-xs text-slate-400 mt-2 hidden">No new pending orders.</div>
</div>
    <div class="max-w-7xl mx-auto px-6 py-10">
      <nav class="flex items-center justify-between mb-8">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 bg-forest-700 rounded-lg flex items-center justify-center shadow-neon text-white font-bold">NT</div>
          <div>
            <h1 class="text-2xl font-semibold">Categories Dashboard</h1>
            <p class="text-sm text-slate-500">Review and update category order status</p>
          </div>
        </div>

        <button id="refreshBtn" class="px-4 py-2 rounded-lg border border-slate-200 hover:bg-slate-50 text-sm">Refresh</button>
      </nav>

      <section class="grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-3">
          <div class="mb-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <input id="search" type="search" placeholder="Search categories..." class="px-4 py-2 rounded-lg border w-72" />
            </div>
            <div class="text-sm text-slate-500">Status: <span id="statusSummary">Listening</span></div>
          </div>

          <div id="cards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 cards-scroll max-h-[60vh] overflow-auto p-2">
            </div>
        </div>
      </section>
    </div>

    <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center bg-black/40">
      <div class="bg-white rounded-xl w-full max-w-lg p-6 shadow-lg">
        <div class="flex items-start justify-between mb-4">
          <div>
            <h3 id="modalTitle" class="text-lg font-semibold">Add remark</h3>
            <p id="modalSubtitle" class="text-sm text-slate-500">Provide a remark before marking order as pending</p>
          </div>
          <button id="modalClose" class="text-slate-400 hover:text-slate-600">✕</button>
        </div>
        <textarea id="remarkInput" rows="5" class="w-full border rounded-md p-3" placeholder="Type remark... (required)"></textarea>
        <div class="mt-4 flex items-center justify-end gap-3">
          <button id="modalCancel" class="px-4 py-2 rounded-lg border">Cancel</button>
          <button id="modalDone" class="btn-3d-red" disabled>Done</button>
        </div>
      </div>
    </div>

    <div id="pendingPopup" class="popup hidden p-5 flex-col">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-lg font-semibold text-sky-500 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-alert-circle"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="12"></line><line x1="12" y1="16" x2="12" y2="16"></line></svg>
          Pending Orders
        </h4>
        <button id="dismissPopup" class="text-sm text-slate-500 hover:text-slate-700">Dismiss</button>
      </div>
      <ul id="pendingList" class="text-sm text-slate-700 space-y-2">
        </ul>
      <div id="noPendingMessage" class="text-xs text-slate-400 mt-2 hidden">No new pending orders.</div>
    </div>

    <script>
// ------------------ Configuration ------------------
      // URL of your Google Apps Script 'doGet' function
      const API_URL = 'https://script.google.com/macros/s/AKfycbza9ne-1hmyL6nkwuo7USvOXZWAw9qgVWgz1AFtBZ4B_oSMUBwlsL8AEcqSBPDcjmmc/exec';
      // URL for direct Sheets fetch (gviz JSON) for the pending popup
      const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1MPBE5EED1iN8np3oVqcn3VSAYl7M-OUXaLj9_YJogh0/gviz/tq?tqx=out:json&sheet=MissedIMSReq';

      // State
      let categories = [];
      const statusMap = {};
      const createdCategoriesToday = new Set();
      let pendingCategoriesToday = [];
      let dismissTimestamp = 0; // Tracks when the user last dismissed the popup

      // Elements
      const cardsEl = document.getElementById('cards');
      const statusSummaryEl = document.getElementById('statusSummary');
      const searchEl = document.getElementById('search');

      const modal = document.getElementById('modal');
      const modalTitle = document.getElementById('modalTitle');
      const modalSubtitle = document.getElementById('modalSubtitle');
      const modalClose = document.getElementById('modalClose');
      const modalCancel = document.getElementById('modalCancel');
      const modalDone = document.getElementById('modalDone');
      const remarkInput = document.getElementById('remarkInput');

      const pendingPopup = document.getElementById('pendingPopup');
      const pendingList = document.getElementById('pendingList');
      const dismissPopupBtn = document.getElementById('dismissPopup');
      const noPendingMessage = document.getElementById('noPendingMessage');

      let activePendingCategory = null;

      // ------------------ Helpers ------------------
      function combineAndDedupe(a = [], b = []){
        const combined = new Set();
        a.concat(b).forEach(item => {
          const t = String(item).trim();
          if (t) combined.add(t);
        });
        return [...combined];
      }

      function escapeHtml(str){ return String(str).replace(/[&<>\"']/g, (s)=> ({'&':'&amp;','<':'&lt;','>':'&gt;','\"':'&quot;',"'":"&#39;"})[s]); }

      function isToday(timestamp) {
        if (!timestamp) return false;
        const date = new Date(timestamp);
        if (isNaN(date)) return false;
        const today = new Date();
        return date.getFullYear() === today.getFullYear() &&
               date.getMonth() === today.getMonth() &&
               date.getDate() === today.getDate();
      }

      function setStatusText(t){ statusSummaryEl.textContent = t; }

      // ------------------ UI Rendering ------------------
      function createCard(category){
        const container = document.createElement('div');
        container.className = 'p-4 bg-white rounded-xl shadow hover:shadow-md transition fade-in';
        container.innerHTML = `
          <div class="flex items-start gap-3">
            <div class="w-10 h-10 rounded-lg bg-slate-100 flex items-center justify-center text-slate-600 font-medium">${category.slice(0,2).toUpperCase()}</div>
            <div>
              <div class="font-semibold">${escapeHtml(category)}</div>
              <div class="text-xs text-slate-400 mt-1">Category</div>
            </div>
          </div>
          <div class="mt-4 flex items-center gap-3 justify-between">
            <button class="btn-3d-green" onclick="handleYes('${escapeHtml(category)}', this)">Yes, Order Created</button>
            <button class="btn-3d-red" onclick="openPendingModal('${escapeHtml(category)}')">No, Order is Pending</button>
            <div class="badge">${statusMap[category] ? statusMap[category] : 'new'}</div>
          </div>
        `;
        return container;
      }

      function renderCards(filterText = ''){
        cardsEl.innerHTML = '';
        const filtered = categories.filter(c => c.toLowerCase().includes(filterText.toLowerCase()));
        if (filtered.length === 0) {
          cardsEl.innerHTML = '<div class="col-span-full p-6 text-center text-slate-500 bg-white rounded-xl shadow">No new categories to show.</div>';
          return;
        }
        filtered.forEach(cat => cardsEl.appendChild(createCard(cat)));
      }

      function renderPendingPopup(){
        pendingList.innerHTML = '';
        if(pendingCategoriesToday && pendingCategoriesToday.length > 0) {
          const deduped = Array.from(new Set(pendingCategoriesToday.map(c => String(c).trim()).filter(Boolean)));
          deduped.forEach(cat => {
            const li = document.createElement('li');
            li.className = 'p-2 bg-neutral-100 rounded-md flex items-center gap-2';
            li.innerHTML = `<span class="w-2 h-2 bg-sky-500 rounded-full"></span>${escapeHtml(cat)}`;
            pendingList.appendChild(li);
          });
          noPendingMessage.classList.add('hidden');
          pendingPopup.classList.remove('hidden');
        } else {
          noPendingMessage.classList.remove('hidden');
          pendingPopup.classList.add('hidden');
          pendingPopup.classList.remove('is-visible');
        }
      }

      // ------------------ Data Fetching (direct from Sheets) ------------------
      async function fetchSheetPendingCategories(){
        try {
          const res = await fetch(SPREADSHEET_URL);
          if (!res.ok) throw new Error('Sheet fetch failed');
          const text = await res.text();
          // JSON is wrapped in a function call; extract the JSON object
          const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
          const data = JSON.parse(jsonText);
          const rows = data.table && data.table.rows ? data.table.rows : [];

          const pending = [];
          const createdToday = new Set();

          rows.forEach(row => {
            const cells = row.c || [];
            // cells[0] -> timestamp, cells[1] -> category, cells[2] -> status
            const rawTs = (cells[0] && (cells[0].f || cells[0].v)) ? (cells[0].f || cells[0].v) : null;
            const category = (cells[1] && (cells[1].v || cells[1].f)) ? (cells[1].v || cells[1].f) : null;
            const status = (cells[2] && (cells[2].v || cells[2].f)) ? String(cells[2].v || cells[2].f).trim().toLowerCase() : null;

            if (!rawTs || !category) return;
            const tsDate = new Date(rawTs);
            if (isNaN(tsDate)) return;

            if (isToday(tsDate)){
              if (status === 'created') createdToday.add(String(category).trim());
              if (status === 'pending') pending.push(String(category).trim());
            }
          });

          return { pending: Array.from(new Set(pending)), createdToday };

        } catch (err) {
          console.error('Failed to fetch sheet', err);
          return { pending: [], createdToday: new Set() };
        }
      }

      // ------------------ Main fetch that populates dashboard categories ------------------
      async function fetchMainCategories(){
        setStatusText('Loading...');
        try{
          const apiRes = await fetch(API_URL);
          if (!apiRes.ok) throw new Error('Network error from Apps Script API');
          const apiData = await apiRes.json();
          const fetchedCategories = combineAndDedupe(apiData.fromColumnB || [], apiData.fromColumnG || []);
          
          const { createdToday } = await fetchSheetPendingCategories();
          
          // Filter out categories that are already marked 'created' today
          categories = fetchedCategories.filter(cat => !createdToday.has(cat));
          
          renderCards(searchEl.value);
          setStatusText('Loaded');
        }catch(err){
          console.error(err);
          setStatusText('Failed to load');
          cardsEl.innerHTML = `<div class="col-span-full p-6 text-center text-red-600 bg-white rounded-xl shadow">Failed to fetch categories — check console.</div>`;
        }
      }

      // ------------------ Popup / interval logic ------------------
      let popupIntervalId = null;
      let suppressUntil = 0; // timestamp to suppress auto-popup after user dismisses

      async function checkAndShowPopup(){
        try{
          const { pending } = await fetchSheetPendingCategories();
          pendingCategoriesToday = pending || [];
          renderPendingPopup();

          if (pendingCategoriesToday.length > 0 && Date.now() > suppressUntil) {
            pendingPopup.classList.remove('hidden');
            setTimeout(() => pendingPopup.classList.add('is-visible'), 60);
          } else {
            pendingPopup.classList.remove('is-visible');
            setTimeout(()=> pendingPopup.classList.add('hidden'), 400);
          }

        }catch(err){
          console.error('Popup check failed', err);
        }
      }

      // ------------------ Events / Actions ------------------
      async function handleYes(category){
        statusMap[category] = 'sending';
        renderCards(searchEl.value);
        try{
          const payload = { category, status: 'created', remark: '' };
          await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          statusMap[category] = 'created';
          await fetchMainCategories();
        }catch(e){
          console.error(e);
          statusMap[category] = 'error';
          alert('Failed to send. Check console for details.');
          renderCards(searchEl.value);
        }
      }

      function openPendingModal(category){
        activePendingCategory = category;
        modalTitle.textContent = `Pending remark — ${category}`;
        remarkInput.value = '';
        modalDone.setAttribute('disabled','');
        modal.classList.remove('hidden');
        modal.classList.add('flex');
        remarkInput.focus();
      }

      function closeModal(){
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        activePendingCategory = null;
      }

      remarkInput.addEventListener('input', ()=>{
        const val = remarkInput.value.trim();
        if (val.length > 0) modalDone.removeAttribute('disabled'); else modalDone.setAttribute('disabled','');
      });

      modalClose.addEventListener('click', closeModal);
      modalCancel.addEventListener('click', closeModal);
      dismissPopupBtn.addEventListener('click', () => {
        suppressUntil = Date.now() + 20000;
        pendingPopup.classList.remove('is-visible');
        setTimeout(() => pendingPopup.classList.add('hidden'), 400);
      });

      modalDone.addEventListener('click', async ()=>{
        const remark = remarkInput.value.trim();
        if (!remark) return;
        const category = activePendingCategory;
        statusMap[category] = 'sending';
        renderCards(searchEl.value);
        try{
          const payload = { category, status: 'pending', remark };
          await fetch(API_URL, { method: 'POST', mode: 'no-cors', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
          statusMap[category] = 'pending';
          closeModal();
          await fetchMainCategories();
        }catch(e){
          console.error(e);
          statusMap[category] = 'error';
          alert('Failed to send pending remark. Check console.');
          renderCards(searchEl.value);
        }
      });

      searchEl.addEventListener('input', ()=> renderCards(searchEl.value));
      document.getElementById('refreshBtn').addEventListener('click', fetchMainCategories);

      // Initial load & periodic updates
      (async function init(){
        await fetchMainCategories();
        await checkAndShowPopup();
        popupIntervalId = setInterval(checkAndShowPopup, 20000);
      })();

      document.addEventListener('DOMContentLoaded', ()=>{ try { feather.replace() } catch(e){} });
    </script>
<script>
  // Add these constants and state variables to the top of your existing script tag
  const SPREADSHEET_URL = 'https://docs.google.com/spreadsheets/d/1MPBE5EED1iN8np3oVqcn3VSAYl7M-OUXaLj9_YJogh0/gviz/tq?tqx=out:json&sheet=MissedIMSReq';
  const pendingPopup = document.getElementById('pendingPopup');
  const pendingList = document.getElementById('pendingList');
  const dismissPopupBtn = document.getElementById('dismissPopup');
  const noPendingMessage = document.getElementById('noPendingMessage');
  let pendingCategoriesToday = [];

  // Add these functions inside your script tag
  function renderPendingPopup() {
    pendingList.innerHTML = '';
    if (pendingCategoriesToday && pendingCategoriesToday.length > 0) {
      const deduped = Array.from(new Set(pendingCategoriesToday.map(c => String(c).trim()).filter(Boolean)));
      deduped.forEach(cat => {
        const li = document.createElement('li');
        li.className = 'p-2 bg-neutral-100 rounded-md flex items-center gap-2';
        li.innerHTML = `<span class="w-2 h-2 bg-sky-500 rounded-full"></span>${escapeHtml(cat)}`;
        pendingList.appendChild(li);
      });
      noPendingMessage.classList.add('hidden');
      pendingPopup.classList.remove('hidden');
      setTimeout(() => pendingPopup.classList.add('is-visible'), 50);
    } else {
      noPendingMessage.classList.remove('hidden');
      pendingPopup.classList.remove('is-visible');
      setTimeout(() => pendingPopup.classList.add('hidden'), 400); // Wait for transition
    }
  }

  async function fetchUpdatedSheetData() {
    try {
      const res = await fetch(SPREADSHEET_URL);
      const text = await res.text();
      const jsonText = text.substring(text.indexOf('{'), text.lastIndexOf('}') + 1);
      const data = JSON.parse(jsonText);
      const rows = data.table.rows;

      const pending = [];
      if (rows && rows.length > 0) {
        rows.forEach(row => {
          const cells = row.c;
          if (cells && cells[0] && cells[0].f && cells[1] && cells[2]) {
            const timestamp = new Date(cells[0].f);
            const category = cells[1].v;
            const status = cells[2].v;

            if (
              timestamp instanceof Date &&
              timestamp.getFullYear() === new Date().getFullYear() &&
              timestamp.getMonth() === new Date().getMonth() &&
              timestamp.getDate() === new Date().getDate() &&
              status === "pending"
            ) {
              pending.push(category);
            }
          }
        });
      }
      pendingCategoriesToday = pending;
      renderPendingPopup();

    } catch(err) {
      console.error('Failed to fetch from Google Sheet', err);
    }
  }

  // Add this event listener
  dismissPopupBtn.addEventListener('click', () => {
    pendingPopup.classList.remove('is-visible');
    setTimeout(() => pendingPopup.classList.add('hidden'), 400); // Wait for transition
  });

  // Call the function on page load and on an interval
  fetchUpdatedSheetData();
  setInterval(fetchUpdatedSheetData, 20000); // Update every 20 seconds
</script>    
  </body>
</html>
