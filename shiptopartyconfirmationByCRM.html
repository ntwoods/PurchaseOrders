<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_top">
  <title>Order Receiving Acknowledgement for Bill To Ship To Orders</title>
  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px 0;
    }

    .main-container {
      max-width: 1000px;
      margin: 0 auto;
      padding: 0 20px;
    }

    .header-section {
      text-align: center;
      color: white;
      margin-bottom: 40px;
      padding: 30px 0;
    }

    .header-section h1 {
      font-size: 2.5em;
      font-weight: 700;
      margin-bottom: 15px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .header-section .tagline {
      font-size: 1.1em;
      opacity: 0.9;
      font-weight: 300;
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.5;
    }

    .content-wrapper {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 30px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
    }

    .order-card {
      background: linear-gradient(145deg, #ffffff, #f8f9fa);
      border-radius: 15px;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
      margin-bottom: 25px;
      padding: 25px;
      position: relative;
      border: 1px solid rgba(0,0,0,0.05);
      transition: all 0.3s ease;
      overflow: hidden;
    }

    .order-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
    }

    .order-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: linear-gradient(90deg, #28a745, #20c997);
    }

    .order-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 20px;
    }

    .order-card h5 {
      color: #2c3e50;
      margin: 0;
      font-size: 1.3em;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-card h5 i {
      color: #007bff;
      font-size: 1.1em;
    }

    .status-badge {
      padding: 8px 15px;
      border-radius: 25px;
      font-weight: 600;
      font-size: 0.85em;
      background: linear-gradient(135deg, #28a745, #20c997);
      color: white;
      box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3); }
      50% { box-shadow: 0 4px 15px rgba(40, 167, 69, 0.5); }
      100% { box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3); }
    }

    .order-details {
      background: rgba(108, 117, 125, 0.05);
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 20px;
    }

    .order-details p {
      margin: 8px 0;
      color: #495057;
      font-weight: 500;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .order-details i {
      color: #6c757d;
      width: 16px;
    }

    .button-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .btn-custom {
      border: none;
      border-radius: 8px;
      padding: 10px 20px;
      font-weight: 600;
      font-size: 0.9em;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }

    .btn-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0,0,0,0.15);
      text-decoration: none;
    }

    .btn-view {
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
    }

    .btn-check {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
    }

    .btn-received {
      background: linear-gradient(135deg, #28a745, #1e7e34);
      color: white;
    }

    .btn-received:hover {
      background: linear-gradient(135deg, #218838, #1c7430);
    }

    .btn-custom:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
    }

    .loading-container, .no-orders-container {
      text-align: center;
      padding: 60px 20px;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid #e3e3e3;
      border-top: 4px solid #007bff;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      color: #6c757d;
      font-size: 1.1em;
      font-weight: 500;
    }

    .no-orders-icon {
      font-size: 4em;
      color: #dc3545;
      margin-bottom: 20px;
    }

    .no-orders-text {
      color: #dc3545;
      font-size: 1.2em;
      font-weight: 500;
    }

    .refresh-btn {
      position: fixed;
      bottom: 30px;
      right: 30px;
      width: 60px;
      height: 60px;
      border-radius: 50%;
      background: linear-gradient(135deg, #007bff, #0056b3);
      color: white;
      border: none;
      font-size: 1.5em;
      box-shadow: 0 8px 20px rgba(0, 123, 255, 0.3);
      transition: all 0.3s ease;
      z-index: 1000;
    }

    .refresh-btn:hover {
      transform: scale(1.1);
      box-shadow: 0 12px 25px rgba(0, 123, 255, 0.4);
    }

    @media (max-width: 768px) {
      .header-section h1 {
        font-size: 2em;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn-custom {
        justify-content: center;
      }
      
      .order-header {
        flex-direction: column;
        gap: 15px;
      }
      
      .refresh-btn {
        bottom: 20px;
        right: 20px;
        width: 50px;
        height: 50px;
        font-size: 1.2em;
      }
    }
  </style>
</head>
<body>
  <div class="main-container">
    <div class="header-section">
      <h1><i class="fas fa-warehouse"></i> Order Receiving Acknowledgement for Bill To Ship To Orders</h1>
      <p class="tagline">CRM will mark the orders receiving here once they confirm an order's goods received by Ship to Party.</p>
    </div>

    <div class="content-wrapper">
      <div id="loadingMessage" class="loading-container">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading pending orders...</div>
      </div>

      <div id="noOrdersMessage" class="no-orders-container" style="display: none;">
        <div class="no-orders-icon">
          <i class="fas fa-inbox"></i>
        </div>
        <div class="no-orders-text">No pending orders found</div>
      </div>

      <div id="orderCardsContainer"></div>
    </div>
  </div>

  <button class="refresh-btn" onclick="fetchOrders()" title="Refresh Orders">
    <i class="fas fa-sync-alt"></i>
  </button>

  <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    const API_URL = 'https://script.google.com/macros/s/AKfycbyxeMMLaslDV2VPH01rLl1zqY-exBSLgFav5GClM1ccvwI2KoFhyZExKefa_alA6P8/exec';
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyxeMMLaslDV2VPH01rLl1zqY-exBSLgFav5GClM1ccvwI2KoFhyZExKefa_alA6P8/exec';

    document.addEventListener('DOMContentLoaded', fetchOrders);

    async function fetchOrders() {
      document.getElementById('loadingMessage').style.display = 'block';
      document.getElementById('noOrdersMessage').style.display = 'none';
      document.getElementById('orderCardsContainer').innerHTML = '';

      // Add rotation animation to refresh button
      const refreshBtn = document.querySelector('.refresh-btn i');
      refreshBtn.style.animation = 'spin 1s linear infinite';

      try {
        const response = await fetch(API_URL);
        const result = await response.json();

        document.getElementById('loadingMessage').style.display = 'none';
        refreshBtn.style.animation = '';

        if (result.success && result.data.length > 0) {
          result.data.forEach(order => {
            renderOrderCard(order);
          });
        } else if (result.success && result.data.length === 0) {
          document.getElementById('noOrdersMessage').style.display = 'block';
        } else {
          console.error('Error fetching orders:', result.error);
          showNotification('Error fetching orders: ' + result.error, 'error');
        }
      } catch (error) {
        document.getElementById('loadingMessage').style.display = 'none';
        refreshBtn.style.animation = '';
        console.error('Network or parsing error:', error);
        showNotification('Network or parsing error: ' + error.message, 'error');
      }
    }

    function normalizeTimestamp(input) {
      if (!input) return null;
      
      try {
        let dateObj;
        
        if (input instanceof Date) {
          dateObj = input;
        } else if (typeof input === 'string') {
          const trimmed = input.trim();
          
          if (trimmed.match(/^\d{2}\/\d{2}\/\d{4} \d{2}:\d{2}:\d{2}$/)) {
            const parts = trimmed.split(' ');
            const datePart = parts[0].split('/');
            const timePart = parts[1].split(':');
            
            dateObj = new Date(
              parseInt(datePart[2]),
              parseInt(datePart[1]) - 1,
              parseInt(datePart[0]),
              parseInt(timePart[0]),
              parseInt(timePart[1]),
              parseInt(timePart[2])
            );
          } else {
            dateObj = new Date(trimmed);
          }
        } else {
          dateObj = new Date(input);
        }
        
        if (isNaN(dateObj.getTime())) {
          console.error('Invalid date created from:', input);
          return null;
        }
        
        const pad = (num) => num.toString().padStart(2, '0');
        return `${pad(dateObj.getDate())}/${pad(dateObj.getMonth() + 1)}/${dateObj.getFullYear()} ${pad(dateObj.getHours())}:${pad(dateObj.getMinutes())}:${pad(dateObj.getSeconds())}`;
        
      } catch (error) {
        console.error('Error normalizing timestamp:', error, 'for input:', input);
        return input;
      }
    }

    function renderOrderCard(order) {
      const container = document.getElementById('orderCardsContainer');
      const card = document.createElement('div');
      card.className = 'order-card';
      
      const normalizedTimestamp = normalizeTimestamp(order.timestamp);
      const displayTimestamp = normalizedTimestamp || order.timestamp;
      
      card.innerHTML = `
        <div class="order-header">
          <h5><i class="fas fa-user"></i> ${order.supplierName || 'N/A'}</h5>
          <span class="status-badge"><i class="fas fa-clock"></i> Pending</span>
        </div>
        
        <div class="order-details">
          <p><i class="fas fa-calendar-alt"></i> <strong>Timestamp:</strong> ${displayTimestamp}</p>
        </div>
        
        <div class="button-group">
          <a href="${order.poURL}" target="_blank" class="btn-custom btn-view">
            <i class="fas fa-eye"></i> View PO
          </a>
          <a href="${order.dispatchDetailURL}" target="_blank" class="btn-custom btn-check">
            <i class="fas fa-truck"></i> Check Dispatch Details
          </a>
          <a href="${order.lrURL}" target="_blank" class="btn-custom btn-check">
            <i class="fas fa-truck"></i> LR Details
          </a>
          <button class="btn-custom btn-received received-btn" 
                  data-original-timestamp="${order.timestamp}" 
                  data-normalized-timestamp="${normalizedTimestamp}" 
                  data-display-timestamp="${displayTimestamp}">
            <i class="fas fa-check-circle"></i> Mark as Received
          </button>
        </div>
      `;
      
      container.appendChild(card);
      card.querySelector('.received-btn').addEventListener('click', handleReceivedClick);
    }

    async function handleReceivedClick(event) {
      const button = event.target.closest('button');
      const originalTimestamp = button.dataset.originalTimestamp;
      const normalizedTimestamp = button.dataset.normalizedTimestamp;
      const displayTimestamp = button.dataset.displayTimestamp;

      if (!normalizedTimestamp && !originalTimestamp) {
        showNotification('Error: Timestamp not found for this order.', 'error');
        return;
      }

      const timestampToSend = normalizedTimestamp || originalTimestamp;

      if (!confirm(`Are you sure you want to mark the order with timestamp "${displayTimestamp}" as Received?`)) {
        return;
      }

      button.disabled = true;
      button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';

      try {
        const response = await fetch(SCRIPT_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ 
            timestamp: timestampToSend,
            debug: {
              original: originalTimestamp,
              normalized: normalizedTimestamp
            }
          })
        });

        showNotification('Order marked as Received!', 'success');
        
        setTimeout(() => {
          fetchOrders();
        }, 1000);

      } catch (error) {
        console.error('Network error:', error);
        showNotification('Network error while marking order as Received: ' + error.message, 'error');
        button.disabled = false;
        button.innerHTML = '<i class="fas fa-check-circle"></i> Mark as Received';
      }
    }

    function showNotification(message, type) {
      const notification = document.createElement('div');
      notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        padding: 15px 25px;
        border-radius: 8px;
        color: white;
        font-weight: 600;
        z-index: 10000;
        max-width: 400px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease;
      `;
      
      if (type === 'success') {
        notification.style.background = 'linear-gradient(135deg, #28a745, #20c997)';
      } else {
        notification.style.background = 'linear-gradient(135deg, #dc3545, #c82333)';
      }
      
      notification.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-triangle'}"></i>
        ${message}
      `;
      
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => {
          document.body.removeChild(notification);
        }, 300);
      }, 3000);
    }

    // Add CSS animations
    const style = document.createElement('style');
    style.textContent = `
      @keyframes slideIn {
        from { transform: translateX(100%); opacity: 0; }
        to { transform: translateX(0); opacity: 1; }
      }
      @keyframes slideOut {
        from { transform: translateX(0); opacity: 1; }
        to { transform: translateX(100%); opacity: 0; }
      }
    `;
    document.head.appendChild(style);
  </script>
</body>
</html>
